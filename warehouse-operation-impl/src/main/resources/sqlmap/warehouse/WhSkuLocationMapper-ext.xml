<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="com.baozun.scm.primservice.whoperation.dao.warehouse.WhSkuLocationDao">
	<resultMap id="WhSkuLocationResultExt" type="com.baozun.scm.primservice.whoperation.command.warehouse.WhSkuLocationCommand">
	</resultMap>
	<resultMap id="WhSkuInventoryCommandResultExt" type="com.baozun.scm.primservice.whoperation.command.warehouse.inventory.WhSkuInventoryCommand">
	</resultMap>
	
	<!-- 用于select查询公用抽取的列 -->
	<sql id="whSkuLocationColumnsExt">
	    <![CDATA[
	        	sl.id as id,
	        	sl.sku_id as skuId,
	        	sl.location_id as locationId,
	        	sl.lifecycle as lifecycle,
	        	sl.modified_id as modifiedId,
	        	sl.last_modify_time as lastModifyTime,
	        	sl.ou_id as ouId,
	        	sku.name as skuName,
	        	sku.ext_code as skuCode,
	        	location.code as locationCode
	    ]]>
	</sql>
	
	<sql id="whSkuLocationDynamicWhereExt">
		<!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
		<where>
	       
				<if test="id!=null">
					and sl.id = #{id}
				</if>
				<if test="ouId!=null">
					and sl.ou_id = #{ouId}
				</if>
	       
				<if test="skuId!=null">
					and sl.sku_id = #{skuId}
				</if>
	       
				<if test="locationId!=null">
					and sl.location_id = #{locationId}
				</if>
	       
				<if test="lifecycle!=null">
					and sl.lifecycle = #{lifecycle}
				</if>
	       
				<if test="modifiedId!=null">
					and sl.modified_id = #{modifiedId}
				</if>
	       
				<if test="lastModifyTime!=null">
					and sl.last_modify_time = #{lastModifyTime}
				</if>
				
				<if test="skuCode!=null and skuCode!=''">
					and sku.ext_code like #{skuCode}
				</if>
				<if test="skuName!=null and skuName!=''">
					and sku.name like #{skuName}
				</if>
				<if test="locationCode!=null and locationCode!=''">
					and location.code like #{locationCode}
				</if>
		</where>
	</sql>
	
	 <select id="findListCountByQueryMapExt" resultType="long">
        select count(*) from t_wh_sku_location 
		<include refid="whSkuLocationDynamicWhere"/>    
    </select>
 <select id="findListByQueryMapWithPageExt" resultMap="WhSkuLocationResultExt">
    	select <include refid="whSkuLocationColumnsExt" />
	    from t_wh_sku_location sl
	    left join t_wh_sku sku on sku.id=sl.sku_id
	    left join t_wh_location location on location.id=sl.location_id
		<include refid="whSkuLocationDynamicWhereExt"/>
		
    </select>
    
 <select id="findSkuLocationToShard" resultMap="WhSkuLocationResultExt">
    	select <include refid="whSkuLocationColumnsExt" />
	    from t_wh_sku_location sl
	    left join t_wh_sku sku  on sku.id=sl.sku_id and sku.ou_id=sl.ou_id
	    left join t_wh_location location on location.id=sl.location_id and sl.ou_id =location.ou_id
		<include refid="whSkuLocationDynamicWhereExt"/>
		
    </select>
	
	<update id="updateByVersion" parameterType="com.baozun.scm.primservice.whoperation.model.warehouse.WhSkuLocation">
	    <![CDATA[
	        UPDATE t_wh_sku_location SET
		        sku_id = #{skuId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        location_id = #{locationId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        lifecycle = #{lifecycle,javaType=java.lang.Integer,jdbcType=INTEGER} ,
		        modified_id = #{modifiedId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        last_modify_time = now() 
	        WHERE 
		        id = #{id} 
		        and ou_id=#{ouId}
		        and last_modify_time=#{lastModifyTime} 
	    ]]>
		</update>
		
	<select id="checkForSaveOrUpdate" parameterType="com.baozun.scm.primservice.whoperation.command.warehouse.WhSkuLocationCommand" resultMap="WhSkuLocationResultExt" flushCache="true" useCache="false">
	select 
	(select sku.lifecycle from t_wh_sku sku where sku.id=#{skuId} and sku.ou_id=#{ouId}) as skuLifecycle,
	(select location.lifecycle from t_wh_location location where location.id=#{locationId} and location.ou_id=#{ouId}) as locationLifecycle,
	(select location.is_static from t_wh_location location where location.id=#{locationId} and location.ou_id=#{ouId}) as locationIsStatic,
	(select (case location.is_mix_stacking when 0 then 1 else IFNULL(location.mix_stacking_number,0) end) from t_wh_location location where location.id=#{locationId} and location.ou_id=#{ouId})
	-(select count(1) from t_wh_sku_location sl where sl.location_id=#{locationId} and sl.ou_id=#{ouId} <if test="id!=null"> and sl.id!=#{id}</if>) as availableMixCount,
	(select count(1) from t_wh_sku_location sl where sl.sku_id=#{skuId} and sl.location_id=#{locationId} and sl.ou_id=#{ouId} <if test="id!=null"> and sl.id!=#{id}</if>) as skuLocationCount
	</select>
	
	 <select id="findByIdOuId" parameterType="map" resultMap="WhSkuLocationResult" flushCache="false">
		select <include refid="whSkuLocationColumns" />
	    <![CDATA[
		    from t_wh_sku_location 
	        where 
	        id = #{id} and ou_id=#{ouId}
	    ]]>
	</select>
	
	<delete id="deleteByIdOuId" parameterType="map">
	    <![CDATA[
	        delete from t_wh_sku_location where
		        id = #{id} and ou_id=#{ouId}
	    ]]>
	    </delete>
	    	
	 <select id="findPalletCountByLocation"  resultType="int">
      select count(1)
	  	from 
	   (select distinct inv.outer_container_id  as outer_container_id
	   from
					t_wh_sku_inventory inv 
					where 
					inv.ou_id = #{ouId}
					and inv.location_id = #{locId}
		) containerList
		where containerList.outer_container_id is not null
    </select> 
	    
	 <select id="findContainerSkuCountNotInSkuLocation"  resultType="int">
      select count(1)
	  	from 
	   (select distinct inv.sku_id  as sku_id
	   from
					t_wh_sku_inventory inv 
					left join t_wh_container c on c.id = inv.inside_container_id
					where 
					inv.ou_id = #{ouId}
					and c.code in 
					<foreach item="item" index="index" collection="containerList" open="(" separator="," close=")">
			            #{item}
			        </foreach>
			        
			        and not exists
			       (
			        select 1 
			      from 
	     			t_wh_sku_location sl
	    			left join t_wh_sku sku  on sku.id=sl.sku_id and sku.ou_id=sl.ou_id
	    			left join t_wh_location location on location.id=sl.location_id and sl.ou_id =location.ou_id
	    
	    			where sl.ou_id = #{ouId}
	    			and sl.location_id = #{locId}
	    			and sl.lifecycle = 1
	    			and location.is_static = 1
	    			and sl.sku_id = inv.sku_id
			       )
		) skuList
		where skuList.sku_id is not null
    </select>
    
    <select id="findSkuCountInSkuLocation"  resultType="int">
      select count(1)
	  	from 
	   ( select distinct sl.sku_id as sku_id 
			      from 
	     			t_wh_sku_location sl
	    			left join t_wh_sku sku  on sku.id=sl.sku_id and sku.ou_id=sl.ou_id
	    			left join t_wh_location location on location.id=sl.location_id and sl.ou_id =location.ou_id
	    
	    			where sl.ou_id = #{ouId}
	    			and sl.location_id = #{locId}
	    			and sl.lifecycle = 1
	    			and location.is_static = 1
	    			and sl.sku_id = #{skuId}
		) skuList
		where skuList.sku_id is not null
    </select>
    
    <select id="findAllSkuCountInSkuLocation"  resultType="int">
      select count(1)
	  	from 
	   ( select distinct sl.sku_id as sku_id 
			      from 
	     			t_wh_sku_location sl
	    			left join t_wh_sku sku  on sku.id=sl.sku_id and sku.ou_id=sl.ou_id
	    			left join t_wh_location location on location.id=sl.location_id and sl.ou_id =location.ou_id
	    
	    			where sl.ou_id = #{ouId}
	    			and sl.location_id = #{locId}
	    			and sl.lifecycle = 1
	    			and location.is_static = 1
		) skuList
		where skuList.sku_id is not null
    </select>
    
    <select id="findOtherSkuInInvLocation"  resultType="java.lang.Long">
		select invSKus.sku_id as sku_id
				from 
				(select inv.sku_id as sku_id 
				from t_wh_sku_inventory inv
				where inv.location_id is not null 
				and inv.sku_id != #{skuId}
				and inv.ou_id = #{ouId}
				and inv.location_id = #{locId}
				group by inv.sku_id
    </select>
    
    <select id="findOtherSkuInTobefilledLocation"  resultType="java.lang.Long">
		select inv.sku_id as sku_id 
				from t_wh_sku_inventory_tobefilled inv
				where inv.location_id is not null 
				and inv.sku_id != #{skuId}
				and inv.ou_id = #{ouId}
				and inv.location_id = #{locId}
				group by inv.sku_id
				) invSkus 
				where invSKus.sku_id is not null 
				group by invSKus.sku_id
    </select>
    
     <select id="findOtherSkuAttrCountInInvLocation"  resultMap="WhSkuInventoryCommandSnResultExt">
     	select invSkuAttrs.sku_id as sku_id,invSkuAttrs.inv_type,invSkuAttrs.inv_status,invSkuAttrs.batch_number,invSkuAttrs.country_of_origin,invSkuAttrs.mfg_date,invSkuAttrs.exp_date,invSkuAttrs.inv_attr1,invSkuAttrs.inv_attr2,invSkuAttrs.inv_attr3,invSkuAttrs.inv_attr4,invSkuAttrs.inv_attr5
		from 
		(select inv.sku_id as sku_id,inv.inv_type as inv_type,inv.inv_status as inv_status,inv.batch_number as batch_number,inv.country_of_origin as country_of_origin,inv.mfg_date as mfg_date,inv.exp_date as exp_date,inv.inv_attr1 as inv_attr1,inv.inv_attr2 as inv_attr2,inv.inv_attr3 as inv_attr3,inv.inv_attr4 as inv_attr4,inv.inv_attr5 as inv_attr5 
		from t_wh_sku_inventory inv
		where inv.location_id is not null 
		and inv.ou_id = #{ouId}
		and inv.location_id = #{locId}
		and inv.sku_id = #{skuId}
		and not exists (
		select
		inv.id
		from t_wh_sku_inventory inv
		where 
		inv.location_id is not null 
		and inv.ou_id = #{ouId}
		and inv.location_id = #{locId}
		<if test="cSql!=null and cSql!=''">
			${cSql}
		</if>
		)
		group by inv.sku_id,inv.inv_type,inv.inv_status,inv.batch_number,inv.country_of_origin,inv.mfg_date,inv.exp_date,inv.inv_attr1,inv.inv_attr2,inv.inv_attr3,inv.inv_attr4,inv.inv_attr5
    </select>
    
    <select id="findOtherSkuAttrCountInTobefilledLocation"  resultMap="WhSkuInventoryCommandSnResultExt">
     select inv.sku_id as sku_id,inv.inv_type as inv_type,inv.inv_status as inv_status,inv.batch_number as batch_number,inv.country_of_origin as country_of_origin,inv.mfg_date as mfg_date,inv.exp_date as exp_date,inv.inv_attr1 as inv_attr1,inv.inv_attr2 as inv_attr2,inv.inv_attr3 as inv_attr3,inv.inv_attr4 as inv_attr4,inv.inv_attr5 as inv_attr5 
		from t_wh_sku_inventory_tobefilled inv
		where inv.location_id is not null 
		and inv.ou_id = #{ouId}
		and inv.location_id = #{locId}
		and inv.sku_id = #{skuId}
		and not exists (
		select
		inv.id
		from t_wh_sku_inventory_tobefilled inv
		where 
		inv.location_id is not null 
		and inv.ou_id = #{ouId}
		and inv.location_id = #{locId}
		<if test="cSql!=null and cSql!=''">
			${cSql}
		</if>
		)
		group by inv.sku_id,inv.inv_type,inv.inv_status,inv.batch_number,inv.country_of_origin,inv.mfg_date,inv.exp_date,inv.inv_attr1,inv.inv_attr2,inv.inv_attr3,inv.inv_attr4,inv.inv_attr5
	</select>
     	
</mapper>
