<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="com.baozun.scm.primservice.whoperation.dao.warehouse.WhSeedingCollectionDao">
	<resultMap id="WhSeedingCollectionResultExt" type="com.baozun.scm.primservice.whoperation.model.warehouse.WhSeedingCollection">
	</resultMap>
	<resultMap id="WhSeedingCollectionCommand" type="com.baozun.scm.primservice.whoperation.command.warehouse.WhSeedingCollectionCommand">
	</resultMap>
	
	<!-- 用于select查询公用抽取的列 -->
	<sql id="whSeedingCollectionColumnsExt">
	    <![CDATA[
	        	id as id,
	        	facility_id as facilityId,
	        	temporary_location_id as temporaryLocationId,
	        	location_id as locationId,
	        	container_id as containerId,
	        	batch as batch,
	        	collection_status as collectionStatus,
	        	ou_id as ouId
	    ]]>
	</sql>
	
	<sql id="whSeedingCollectionDynamicWhereExt">
		<!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
		<where>
	       
				<if test="id!=null">
					and id = #{id}
				</if>
	       
				<if test="facilityId!=null">
					and facility_id = #{facilityId}
				</if>
	       
				<if test="temporaryLocationId!=null">
					and temporary_location_id = #{temporaryLocationId}
				</if>
	       
				<if test="locationId!=null">
					and location_id = #{locationId}
				</if>
	       
				<if test="containerId!=null">
					and container_id = #{containerId}
				</if>
	       
				<if test="collectionStatus!=null">
					and collection_status = #{collectionStatus}
				</if>
	       
	       
		       <if test="batch!=null and batch!=''">
					and batch = #{batch}
				</if>
	       
				<if test="ouId!=null">
					and ou_id = #{ouId}
				</if>
		</where>
	</sql>
	
	<select id="getSeedingNumFromFacility" resultType="int">
		select
			count(1)
		from
			t_wh_seeding_collection s
		where
			IFNULL(s.collection_status, 0) != 10
			and s.facility_id = #{fid} 
			and s.batch = #{batch}
			and s.ou_id = #{ouId}
	</select>

	<select id="countCapacityByParamExt" resultType="int">
        select count(*) from t_wh_seeding_collection sc, t_wh_outbound_facility facility
        where sc.facility_id = facility.id
        
        <if test="seedingwallCode!=null and seedingwallCode!=''">
        	and facility.facility_code = #{seedingwallCode}
        </if>
        
        <if test="id!=null">
			and sc.id = #{id}
		</if>
      
		<if test="facilityId!=null">
			and sc.facility_id = #{facilityId}
		</if>
      
		<if test="temporaryLocationId!=null">
			and sc.temporary_location_id = #{temporaryLocationId}
		</if>
      
		<if test="locationId!=null">
			and sc.location_id = #{locationId}
		</if>
      
		<if test="containerId!=null">
			and sc.container_id = #{containerId}
		</if>
      
       <if test="batch!=null and batch!=''">
			and sc.batch = #{batch}
		</if>

       <if test="collectionStatus!=null">
			and sc.collection_status != #{collectionStatus}
		</if>
      
		<if test="ouId!=null">
			and sc.ou_id = #{ouId}
		</if>
    </select>
    
    <select id="findByIdAndOuId" parameterType="java.lang.Long" resultMap="WhSeedingCollectionResult" flushCache="false">
			select <include refid="whSeedingCollectionColumnsExt" />
		    <![CDATA[
			    from t_wh_seeding_collection 
		        where 
		        id = #{id} 
		        and ou_id = #{ouId}
		    ]]>
		</select>	
	
	<select id="getSeedingCollectionByContainerCode" resultMap="WhSeedingCollectionCommand">
		select  
			s.id as id,
        	s.facility_id as facilityId,
        	s.temporary_location_id as temporaryLocationId,
        	s.location_id as locationId,
        	s.container_id as containerId,
        	s.batch as batch,
        	s.collection_status as collectionStatus,
        	s.ou_id as ouId
		from
			t_wh_seeding_collection s
			left join t_wh_container c on s.container_id = c.id
		where 
			c.code = #{containerCode}
			and IFNULL(s.collection_status, 1) = 1
			and s.ou_id = #{ouId}
	</select>
	
	<select id="checkBatchIsAllIntoSeedingWall" resultType="int">
		select
			count(1)
		from
			t_wh_seeding_collection s
		where
			s.batch = #{batch}
			and (s.temporary_location_id is not null or s.location_id is not null)
			and s.collection_status = 1
			and s.ou_id = #{ouId}
	</select>
	
	<update id="updateContainerToSeedingWall">
		update 
			t_wh_seeding_collection s 
		set 
			s.facility_id = #{facilityId} 
			s.temporary_location_id = null
		where 
			s.container_id = #{containerId}
			and s.batch = #{batch} 
			and s.ou_id = #{ouId}
	</update>
	
	<delete id="deleteContainerInSeedingWall">
		delete from 
			t_wh_seeding_collection
		where 
			container_id = #{containerId}
			and batch = #{batch} 
			and ou_id = #{ouId}
	</delete>
	
	<select id="checkCountInDestination" resultType="int">
		select
			count(1)
		from
			t_wh_seeding_collection s
		where
			s.batch = #{batch}
			<if test="destinationType != null and destinationType == 2">
				and s.temporary_location_id is not null
			</if>
			<if test="destinationType != null and destinationType == 3">
				and s.location_id is not null
			</if>
			and s.collection_status = 1
			and s.ou_id = #{ouId}
	</select>

    <select id="getSeedingCollectionByFacilityId" resultMap="WhSeedingCollectionResultExt">
        select <include refid="whSeedingCollectionColumns"/>
        from t_wh_seeding_collection
        where facility_id = #{facilityId}
        and ou_id = #{ouId}

    </select>
    
    <select id="findSeedingCollection" resultMap="WhSeedingCollectionResultExt">
    	select <include refid="whSeedingCollectionColumnsExt" />
	    from t_wh_seeding_collection 
		where ou_id = #{ouId}
		and facility_id = #{facilityId}
		and collection_status in
		<foreach item="item"  collection="collectionStatus" open="("
					separator="," close=")">
		#{item}</foreach>
		
    </select>

    <select id="getFacilityBindBatch" resultType="String">
        select distinct batch
        from t_wh_seeding_collection
        where facility_id = #{facilityId}
        and ou_id = #{ouId}
    </select>

</mapper>
