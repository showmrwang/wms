<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="com.baozun.scm.primservice.whoperation.dao.warehouse.WhSeedingCollectionDao">
	<resultMap id="WhSeedingCollectionResultExt" type="com.baozun.scm.primservice.whoperation.model.warehouse.WhSeedingCollection">
	</resultMap>
	<resultMap id="WhSeedingCollectionCommand" type="com.baozun.scm.primservice.whoperation.command.warehouse.WhSeedingCollectionCommand">
	</resultMap>
	
	<!-- 用于select查询公用抽取的列 -->
	<sql id="whSeedingCollectionColumnsExt">
	    <![CDATA[
	        	id as id,
	        	facility_id as facilityId,
	        	temporary_location_id as temporaryLocationId,
	        	location_id as locationId,
	        	container_id as containerId,
	        	batch as batch,
	        	wave_code as waveCode,
	        	collection_status as collectionStatus,
	        	ou_id as ouId,
	        	outer_container_id as outerContainerId,
	        	container_lattice_no as containerLatticeNo,
	        	outboundbox_id as outboundboxId,
	        	outboundbox_code as outboundboxCode,
	        	distribution_mode as distributionMode,
	        	picking_mode as pickingMode,
	        	checking_mode as checkingMode,
	        	create_id as createId,
                create_time as createTime,
	        	last_modify_time as lastModifyTime,
	        	modified_id as modifiedId
	    ]]>
	</sql>
	
	<sql id="whSeedingCollectionDynamicWhereExt">
		<!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
		<where>
	       
				<if test="id!=null">
					and id = #{id}
				</if>
	       
				<if test="facilityId!=null">
					and facility_id = #{facilityId}
				</if>
	       
				<if test="temporaryLocationId!=null">
					and temporary_location_id = #{temporaryLocationId}
				</if>
	       
				<if test="locationId!=null">
					and location_id = #{locationId}
				</if>
	       
				<if test="containerId!=null">
					and container_id = #{containerId}
				</if>
	       
	       
		       <if test="batch!=null and batch!=''">
					and batch = #{batch}
				</if>
	       
	       
		       <if test="waveCode!=null and waveCode!=''">
					and wave_code = #{waveCode}
				</if>
	       
	       
		       <if test="collectionStatus!=null">
					and collection_status = #{collectionStatus}
				</if>
	       
				<if test="ouId!=null">
					and ou_id = #{ouId}
				</if>
	       
				<if test="outerContainerId!=null">
					and outer_container_id = #{outerContainerId}
				</if>
	       
				<if test="containerLatticeNo!=null">
					and container_lattice_no = #{containerLatticeNo}
				</if>
	       
				<if test="outboundboxId!=null">
					and outboundbox_id = #{outboundboxId}
				</if>
	       
	       
		       <if test="outboundboxCode!=null and outboundboxCode!=''">
					and outboundbox_code = #{outboundboxCode}
				</if>
	       
	       
		       <if test="distributionMode!=null and distributionMode!=''">
					and distribution_mode = #{distributionMode}
				</if>
	       
	       
		       <if test="pickingMode!=null and pickingMode!=''">
					and picking_mode = #{pickingMode}
				</if>
	       
	       
		       <if test="checkingMode!=null and checkingMode!=''">
					and checking_mode = #{checkingMode}
				</if>
				
				<if test="createTime!=null">
					and create_time = #{createTime}
				</if>
	       
				<if test="lastModifyTime!=null">
					and last_modify_time = #{lastModifyTime}
				</if>
	       
				<if test="createId!=null">
					and create_id = #{createId}
				</if>
	       
				<if test="modifiedId!=null">
					and modified_id = #{modifiedId}
				</if>
		</where>
	</sql>

    <update id="updateByVersion" parameterType="com.baozun.scm.primservice.whoperation.model.warehouse.WhSeedingCollection">
        <![CDATA[
            UPDATE t_wh_seeding_collection SET
                facility_id = #{facilityId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        temporary_location_id = #{temporaryLocationId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        location_id = #{locationId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        container_id = #{containerId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        batch = #{batch,javaType=java.lang.String,jdbcType=VARCHAR} ,
		        wave_code = #{waveCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
		        collection_status = #{collectionStatus,javaType=java.lang.Integer,jdbcType=INTEGER} ,
		        outer_container_id = #{outerContainerId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        container_lattice_no = #{containerLatticeNo,javaType=java.lang.Integer,jdbcType=INTEGER} ,
		        outboundbox_id = #{outboundboxId,javaType=java.lang.Long,jdbcType=BIGINT} ,
		        outboundbox_code = #{outboundboxCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
		        distribution_mode = #{distributionMode,javaType=java.lang.String,jdbcType=VARCHAR} ,
		        picking_mode = #{pickingMode,javaType=java.lang.String,jdbcType=VARCHAR} ,
		        checking_mode = #{checkingMode,javaType=java.lang.String,jdbcType=VARCHAR} ,
		        create_id = #{createId,javaType=java.lang.Long,jdbcType=BIGINT} , 
                create_time = #{createTime,javaType=java.util.Date,jdbcType=TIMESTAMP} , 
		        last_modify_time = now(),
		        modified_id = #{modifiedId,javaType=java.lang.Long,jdbcType=BIGINT} 
	        WHERE
                id = #{id}
                and ou_id = #{ouId,javaType=java.lang.Long,jdbcType=BIGINT}
                and last_modify_time	=  #{lastModifyTime}  
        ]]>
    </update>
	
	<select id="getSeedingNumFromFacility" resultType="int">
		select
			count(1)
		from
			t_wh_seeding_collection s
		where
			IFNULL(s.collection_status, 0) != 10
			and s.facility_id = #{fid} 
			and s.batch = #{batch}
			and s.ou_id = #{ouId}
	</select>

	<select id="countCapacityByParamExt" resultType="int">
        select count(*) from t_wh_seeding_collection sc, t_wh_outbound_facility facility
        where sc.facility_id = facility.id
        
        <if test="facilityCode!=null and facilityCode!=''">
        	and facility.facility_code = #{facilityCode}
        </if>
        
        <if test="id!=null">
			and sc.id = #{id}
		</if>
      
		<if test="facilityId!=null">
			and sc.facility_id = #{facilityId}
		</if>
      
		<if test="temporaryLocationId!=null">
			and sc.temporary_location_id = #{temporaryLocationId}
		</if>
      
		<if test="locationId!=null">
			and sc.location_id = #{locationId}
		</if>
      
		<if test="containerId!=null">
			and sc.container_id = #{containerId}
		</if>
      
       <if test="batch!=null and batch!=''">
			and sc.batch = #{batch}
		</if>

       <if test="collectionStatus!=null">
			and sc.collection_status != #{collectionStatus}
		</if>
      
		<if test="ouId!=null">
			and sc.ou_id = #{ouId}
		</if>
		
		 <if test="waveCode!=null and waveCode!=''">
			and sc.wave_code = #{waveCode}
		</if>
		
		<if test="outerContainerId!=null">
			and sc.outer_container_id = #{outerContainerId}
		</if>
      
		<if test="containerLatticeNo!=null">
			and sc.container_lattice_no = #{containerLatticeNo}
		</if>
      
		<if test="outboundboxId!=null">
			and sc.outboundbox_id = #{outboundboxId}
		</if>
      
      
       <if test="outboundboxCode!=null and outboundboxCode!=''">
			and sc.outboundbox_code = #{outboundboxCode}
		</if>
      
      
       <if test="distributionMode!=null and distributionMode!=''">
			and sc.distribution_mode = #{distributionMode}
		</if>
      
      
       <if test="pickingMode!=null and pickingMode!=''">
			and sc.picking_mode = #{pickingMode}
		</if>
      
      
       <if test="checkingMode!=null and checkingMode!=''">
			and sc.checking_mode = #{checkingMode}
		</if>
    </select>
    
    <select id="findByIdAndOuId" parameterType="java.lang.Long" resultMap="WhSeedingCollectionResult" flushCache="false">
			select <include refid="whSeedingCollectionColumnsExt" />
		    <![CDATA[
			    from t_wh_seeding_collection 
		        where 
		        id = #{id} 
		        and ou_id = #{ouId}
		    ]]>
		</select>	
	
	<select id="getSeedingCollectionByContainerCode" resultMap="WhSeedingCollectionCommand">
		select  
			s.id as id,
        	s.facility_id as facilityId,
        	s.temporary_location_id as temporaryLocationId,
        	s.location_id as locationId,
        	s.container_id as containerId,
        	s.batch as batch,
        	s.collection_status as collectionStatus,
        	s.ou_id as ouId
		from
			t_wh_seeding_collection s
			left join t_wh_container c on s.container_id = c.id
		where 
			c.code = #{containerCode}
			and IFNULL(s.collection_status, 1) != 10
			and s.ou_id = #{ouId}
	</select>
	
	<select id="checkBatchIsAllIntoSeedingWall" resultType="int">
		select
			count(1)
		from
			t_wh_seeding_collection s
		where
			s.batch = #{batch}
			and (s.temporary_location_id is not null or s.location_id is not null)
			and s.collection_status in (1, 2, 3)
			and s.ou_id = #{ouId}
	</select>
	
	<update id="updateContainerToSeedingWall">
		update 
			t_wh_seeding_collection s 
		set 
			s.facility_id = #{facilityId} 
			s.temporary_location_id = null
		where 
			s.container_id = #{containerId}
			and s.batch = #{batch} 
			and s.ou_id = #{ouId}
	</update>
	
	<delete id="deleteContainerInSeedingWall">
		delete from 
			t_wh_seeding_collection
		where 
			container_id = #{containerId}
			and batch = #{batch} 
			and ou_id = #{ouId}
	</delete>

	<delete id="deleteByIdExt">
		delete from 
			t_wh_seeding_collection
		where 
			id = #{id}
			and ou_id = #{ouId}
	</delete>
	
	<select id="checkCountInDestination" resultType="int">
		select
			count(1)
		from
			t_wh_seeding_collection s
		where
			s.batch = #{batch}
			<if test="destinationType != null and destinationType == 2">
				and s.temporary_location_id is not null
				and s.collection_status = 3
			</if>
			<if test="destinationType != null and destinationType == 3">
				and s.location_id is not null
				and s.collection_status = 2
			</if>
			and s.ou_id = #{ouId}
	</select>

    <select id="getSeedingCollectionByFacilityId" resultMap="WhSeedingCollectionCommand">
        select
            seedingCollection.id as id,
            seedingCollection.facility_id as facilityId,
            seedingCollection.temporary_location_id as temporaryLocationId,
            seedingCollection.location_id as locationId,
            seedingCollection.container_id as containerId,
            seedingCollection.batch as batch,
            seedingCollection.collection_status as collectionStatus,
            seedingCollection.ou_id as ouId,
            outboundFacility.facility_code as facilityCode,
            container.code as containerCode
        from
            t_wh_seeding_collection as seedingCollection
            left join t_wh_outbound_facility as outboundFacility
                on outboundFacility.id = seedingCollection.facility_id and outboundFacility.batch = seedingCollection.batch
            left join t_wh_container as container on container.id = seedingCollection.container_id
        where
            seedingCollection.facility_id = #{facilityId}
            and seedingCollection.ou_id = #{ouId}
            <if test="collectionStatus != null and collectionStatus != ''">
            	AND seedingCollection.collection_status >= #{collectionStatus}
			</if>
            and outboundFacility.facility_code is not null
    </select>
    
    <select id="findSeedingCollection" resultMap="WhSeedingCollectionResultExt">
    	select <include refid="whSeedingCollectionColumnsExt" />
	    from t_wh_seeding_collection 
		where ou_id = #{ouId}
		and facility_id = #{facilityId}
		and collection_status in
		<foreach item="item"  collection="collectionStatus" open="("
					separator="," close=")">
		#{item}</foreach>
		
    </select>



    <select id="getSeedingCollectionByTurnoverBox" resultMap="WhSeedingCollectionCommand">
        select
            seedingCollection.id as id,
            seedingCollection.facility_id as facilityId,
            seedingCollection.temporary_location_id as temporaryLocationId,
            seedingCollection.location_id as locationId,
            seedingCollection.container_id as containerId,
            seedingCollection.batch as batch,
            seedingCollection.collection_status as collectionStatus,
            seedingCollection.ou_id as ouId,
            outboundFacility.facility_code as facilityCode,
            container.code as containerCode
        from
            t_wh_seeding_collection as seedingCollection
            left join t_wh_outbound_facility as outboundFacility
                on outboundFacility.id = seedingCollection.facility_id and outboundFacility.batch = seedingCollection.batch
            left join t_wh_container as container on container.id = seedingCollection.container_id
        where
            seedingCollection.facility_id = #{facilityId}
            and seedingCollection.ou_id = #{ouId}
            and outboundFacility.facility_code is not null
            and container.code = #{turnoverBoxCode}
    </select>

    <select id="getSeedingCollectionById" resultMap="WhSeedingCollectionCommand">
        select
            seedingCollection.id as id,
            seedingCollection.facility_id as facilityId,
            seedingCollection.temporary_location_id as temporaryLocationId,
            seedingCollection.location_id as locationId,
            seedingCollection.container_id as containerId,
            seedingCollection.batch as batch,
            seedingCollection.collection_status as collectionStatus,
            seedingCollection.ou_id as ouId,
            outboundFacility.facility_code as facilityCode,
            container.code as containerCode
        from
            t_wh_seeding_collection as seedingCollection
            left join t_wh_outbound_facility as outboundFacility
            on outboundFacility.id = seedingCollection.facility_id and outboundFacility.batch = seedingCollection.batch
            left join t_wh_container as container on container.id = seedingCollection.container_id
        where
            seedingCollection.id = #{seedingCollectionId}
            and seedingCollection.ou_id = #{ouId}
    </select>

	<select id="findSeedingCollectionByContainerId" resultMap="WhSeedingCollectionResultExt">
		select
			<include refid="whSeedingCollectionColumnsExt"/>
		from 
			t_wh_seeding_collection
		where 
			container_id = #{containerId}
			<if test="batch != null and batch != ''">
				and batch = #{batch} 
			</if>
			and ou_id = #{ouId}
			and IFNULL(collection_status, 1) != 10
	</select>

	<select id="getSeedingBatchOdoInfo"
		resultType="com.baozun.scm.primservice.whoperation.model.seeding.WhSeedingWallLattice">
		SELECT
		#{batchNo} AS batch,
		odo.id AS odoId,
		odo.odo_code AS odoCode,
		odo.ext_code AS extCode,
		odo.ec_order_code AS ecOrderCode,
		odo.odo_status AS odoStatus,
		odo.customer_id AS customerId,
		odo.store_id AS storeId,
		customer.customer_code AS customerCode,
		customer.customer_name AS customerName,
		store.store_code AS storeCode,
		store.store_name AS storeName
		FROM
		t_wh_odo AS odo
		LEFT JOIN sys_dictionary AS odoStatusSys ON odo.odo_status =
		odoStatusSys.dic_value
		AND odoStatusSys.group_value = "ODO_STATUS"
		LEFT JOIN t_bi_customer AS customer ON odo.customer_id = customer.id
		LEFT JOIN t_bi_store AS store ON odo.store_id = store.id
		WHERE
		odo.id IN (
		SELECT DISTINCT
		li.odo_id
		FROM
		t_wh_work AS wo
		LEFT JOIN t_wh_work_line li ON wo.id = li.work_id
		WHERE
		wo.batch = #{batchNo}
		)
	</select>

	<select id="getSeedingBatchOdoLineInfo"
		resultType="com.baozun.scm.primservice.whoperation.model.seeding.WhSeedingWallLatticeLine">
		SELECT
		sku.id AS skuId,
		sku.CODE AS skuCode,
		sku.ext_code AS skuExtCode,
		sku.bar_code AS
		skuBarCode,
		sku. NAME AS skuName,
		odoLine.plan_qty AS qty,
		odo.qty AS odoQty,
		customer.customer_code AS customerCode,
		customer.customer_name AS
		customerName,
		store.store_code AS storeCode,
		store.store_name AS
		storeName,
		skuInv.inv_status AS invStatus,
		invStatus.name AS invStatusName,
		skuInv.inv_type AS invType,
		WORK.batch AS batchNumber,
		skuInv.mfg_date AS mfgDate,
		skuInv.exp_date AS
		expDate,
		skuInv.country_of_origin AS countryOfOrigin,
		skuInv.inv_attr1 AS
		invAttr1,
		skuInv.inv_attr1 AS invAttr2,
		skuInv.inv_attr1 AS invAttr3,
		skuInv.inv_attr1 AS invAttr4,
		skuInv.inv_attr1 AS invAttr5,
		skuInv.uuid
		FROM
		t_wh_odo_line odoLine
		LEFT JOIN t_wh_sku sku ON odoLine.sku_id =
		sku.id
		LEFT JOIN t_wh_odo odo ON odoLine.odo_id = odo.id
		LEFT JOIN
		t_bi_customer customer ON odo.customer_id = customer.id
		LEFT JOIN
		t_bi_store store ON odo.store_id = store.id
		LEFT JOIN t_wh_sku_inventory
		skuInv ON odo.odo_code =
		skuInv.occupation_code
		AND odoLine.id =
		skuInv.occupation_line_id
		LEFT JOIN t_wh_wave_line waveLine ON
		waveLine.odo_line_id = odoLine.id
		AND waveLine.odo_id = odo.id
		LEFT JOIN t_wh_work WORK ON WORK .wave_id = waveLine.wave_id
		LEFT JOIN t_wh_inventory_status AS invStatus ON skuInv.inv_status = invStatus.id
		WHERE
		odoLine.id =#{odoLineId}
		AND sku.ou_id = #{ouId}
		GROUP BY
		skuInv.uuid
	</select>

    <select id="findByIdExt" resultMap="WhSeedingCollectionResultExt">
        SELECT
            <include refid="whSeedingCollectionColumnsExt"/>
        FROM
          t_wh_seeding_collection
        WHERE
            id = #{seedingCollectionId}
            and ou_id = #{ouId}
    </select>
    
    <select id="findWhSeedingCollectionByBatchNo" resultMap="WhSeedingCollectionResultExt">
        SELECT
            <include refid="whSeedingCollectionColumnsExt"/>
        FROM
          t_wh_seeding_collection
        WHERE
            batch = #{batchNo}
            and ou_id = #{ouid}
    </select>

    <select id="countOccupationByFacilityCode" resultType="int">
	    SELECT
			count(1)
		FROM
			t_wh_seeding_collection sc
		LEFT JOIN t_wh_outbound_facility facility ON sc.facility_id = facility.id
		WHERE
			sc.collection_status != 10
		AND sc.ou_id = #{ouId}
		AND facility.facility_code = #{seedingWallCode}
    </select>
    
    <select id="countNotHaveFacilityIdByBatch" resultType="int">
		select 
			count(1)
		from 
			t_wh_seeding_collection
		where
			batch = #{batch}
			and facility_id is null
            and ou_id = #{ouId}
    </select>
    
    <update id="updateFacilityByBatch">
    	update
    		t_wh_seeding_collection
    	set
    		facility_id = #{facilityId}
    	where
    		batch = #{batch}
            and ou_id = #{ouId}
    </update>
</mapper>
