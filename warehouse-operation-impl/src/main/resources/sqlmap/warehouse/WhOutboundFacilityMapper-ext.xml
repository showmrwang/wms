<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.baozun.scm.primservice.whoperation.dao.warehouse.WhOutboundFacilityDao">
    <resultMap id="WhOutboundFacilityResultExt" type="com.baozun.scm.primservice.whoperation.model.warehouse.WhOutboundFacility">
    </resultMap>

    <resultMap id="WhOutboundFacilityCommand" type="com.baozun.scm.primservice.whoperation.command.warehouse.WhOutboundFacilityCommand">
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="whOutboundFacilityColumnsExt">
        <![CDATA[
                id as id,
                facility_code as facilityCode,
                facility_name as facilityName,
                facility_type as facilityType,
                outboundbox_type_id as outboundboxTypeId,
                capacity as capacity,
                facility_lower_limit as facilityLowerLimit,
                facility_upper_limit as facilityUpperLimit,
                facility_group as facilityGroup,
                check_code as checkCode,
                create_time as createTime,
                last_modify_time as lastModifyTime,
                operator_id as operatorId,
                lifecycle as lifecycle,
                status as status,
                batch as batch,
                ou_id as ouId
        ]]>
    </sql>
	
	<sql id="whOutboundFacilitySearchColumnsExt">
		f.id as id,
		f.facility_code as facilityCode,
		f.facility_name as facilityName,
		f.facility_type as facilityType,
		f.outboundbox_type_id as outboundboxTypeId,
		f.capacity as capacity,
		f.facility_lower_limit as facilityLowerLimit,
		f.facility_upper_limit as facilityUpperLimit,
		f.facility_group as facilityGroup,
		f.check_code as checkCode,
		f.create_time as createTime,
		f.last_modify_time as lastModifyTime,
		f.operator_id as operatorId,
		f.lifecycle as lifecycle,
		f.status as status,
		f.batch as batch,
		f.ou_id as ouId,
		sys.dic_label as facilityTypeName,
		t.name as outboundboxTypeName,
		g.facility_group_name as facilityGroupName
	</sql>
	
    <sql id="whOutboundFacilityDynamicWhereExt">
        <!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
        <where>

            <if test="id!=null">
                and id = #{id}
            </if>

            <if test="facilityCode!=null and facilityCode!=''">
                and facility_code = #{facilityCode}
            </if>

            <if test="facilityName!=null and facilityName!=''">
                and facility_name = #{facilityName}
            </if>

            <if test="facilityType!=null and facilityType!=''">
                and facility_type = #{facilityType}
            </if>

            <if test="outboundboxTypeId!=null">
                and outboundbox_type_id = #{outboundboxTypeId}
            </if>
			
			<if test="capacity != null">
       			and capacity = #{capacity}
       		</if>
       		
			<if test="facilityLowerLimit != null">
       			and facility_lower_limit = #{facilityLowerLimit}
       		</if>
       		
			<if test="facilityUpperLimit != null">
       			and facility_upper_limit = #{facilityUpperLimit}
       		</if>
			
            <if test="facilityGroup!=null">
                and facility_group = #{facilityGroup}
            </if>
            
            <if test="checkCode != null and checkCode != ''">
                and check_code = #{checkCode}
            </if>

            <if test="createTime!=null">
                and create_time = #{createTime}
            </if>

            <if test="lastModifyTime!=null">
                and last_modify_time = #{lastModifyTime}
            </if>

            <if test="operatorId!=null">
                and operator_id = #{operatorId}
            </if>

            <if test="lifecycle!=null">
                and lifecycle = #{lifecycle}
            </if>
            
            <if test="status!=null">
                and status = #{status}
            </if>

            <if test="ouId!=null">
                and ou_id = #{ouId}
            </if>
        </where>
    </sql>
    
    <sql id="whOutboundFacilityDynamicSerachWhereExt">
        <!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
        <where>

            <if test="facilityCode!=null and facilityCode!=''">
                and f.facility_code like #{facilityCode}
            </if>

            <if test="facilityName!=null and facilityName!=''">
                and f.facility_name like #{facilityName}
            </if>

            <if test="facilityTypeList != null and facilityTypeList.size > 0">
                and f.facility_type in 
                <foreach collection="facilityTypeList" item="type" open="(" separator="," close=")">
					#{type}
				</foreach>
            </if>

            <if test="outboundboxTypeList != null and outboundboxTypeList.size > 0">
                and f.outboundbox_type_id in 
                <foreach collection="outboundboxTypeList" item="tid" open="(" separator="," close=")">
					#{tid}
				</foreach>
            </if>
			
			<if test="capacity != null">
       			and f.capacity = #{capacity}
       		</if>
       		
			<if test="facilityLowerLimit != null">
       			and f.facility_lower_limit = #{facilityLowerLimit}
       		</if>
       		
			<if test="facilityUpperLimit != null">
       			and f.facility_upper_limit = #{facilityUpperLimit}
       		</if>
       		
            <if test="facilityGroupList != null and facilityGroupList.size > 0">
                and f.facility_group in 
                <foreach collection="facilityGroupList" item="gid" open="(" separator="," close=")">
					#{gid}
				</foreach>
            </if>
			
			<if test="checkCode != null and checkCode != ''">
                and f.check_code like #{checkCode}
            </if>
			
            <if test="lifecycle!=null">
                and f.lifecycle = #{lifecycle}
            </if>

            <if test="ouId!=null">
                and f.ou_id = #{ouId}
            </if>
        </where>
    </sql>

    <update id="saveOrUpdateByVersion" parameterType="com.baozun.scm.primservice.whoperation.model.warehouse.WhOutboundFacility">
        <![CDATA[
                UPDATE t_wh_outbound_facility SET
                    facility_code = #{facilityCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                    facility_name = #{facilityName,javaType=java.lang.String,jdbcType=VARCHAR} ,
                    facility_type = #{facilityType,javaType=java.lang.String,jdbcType=VARCHAR} ,
                    outboundbox_type_id = #{outboundboxTypeId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    capacity = #{capacity,javaType=java.lang.Integer,jdbcType=INTEGER} ,
                    facility_lower_limit = #{facilityLowerLimit,javaType=java.lang.Integer,jdbcType=INTEGER} ,
                    facility_upper_limit = #{facilityUpperLimit,javaType=java.lang.Integer,jdbcType=INTEGER} ,
                    facility_group = #{facilityGroup,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    check_code = #{checkCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                    create_time = #{createTime,javaType=java.util.Date,jdbcType=TIMESTAMP} ,
                    batch = #{batch,javaType=java.lang.String,jdbcType=VARCHAR} ,
                    last_modify_time = now() ,
                    operator_id = #{operatorId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    status = #{status,javaType=java.lang.String,jdbcType=VARCHAR},
                    lifecycle = #{lifecycle,javaType=java.lang.Integer,jdbcType=INTEGER}
                WHERE 
                    id = #{id} 
                    and ou_id = #{ouId} 
                    and last_modify_time =  #{lastModifyTime}    
            ]]>
    </update>

    <select id="findListByOutboundFacilityGroup" resultMap="WhOutboundFacilityCommand">
        select
            <include refid="whOutboundFacilityColumnsExt"/>
        from
            t_wh_outbound_facility
        where
            ou_id = #{ouId}
            and facility_group = #{facilityGroup}
    </select>
	
	<select id="findListCountByQueryMapExt" resultType="long">
        select count(*) from t_wh_outbound_facility f
		<include refid="whOutboundFacilityDynamicSerachWhereExt"/>    
    </select>
	
	<select id="findListByQueryMapWithPageExt" resultMap="WhOutboundFacilityCommand">
		select 
			<include refid="whOutboundFacilitySearchColumnsExt"/>    
		from 
			t_wh_outbound_facility f
			left join sys_dictionary sys on (sys.dic_value = f.facility_type and sys.group_value = 'FACILITY_TYPE')
			left join t_wh_outboundbox_type t on f.outboundbox_type_id = t.id
			left join t_wh_outbound_facility_group g on f.facility_group = g.id
		<include refid="whOutboundFacilityDynamicSerachWhereExt"/>
	</select>
	
	<select id="findByIdExt" resultMap="WhOutboundFacilityCommand">
		select 
			f.id as id,
			f.facility_code as facilityCode,
			f.facility_name as facilityName,
			f.facility_type as facilityType,
			f.outboundbox_type_id as outboundboxTypeId,
			f.capacity as capacity,
			f.facility_lower_limit as facilityLowerLimit,
			f.facility_upper_limit as facilityUpperLimit,
			f.facility_group as facilityGroup,
			f.check_code as checkCode,
			f.create_time as createTime,
			f.last_modify_time as lastModifyTime,
			f.operator_id as operatorId,
			f.lifecycle as lifecycle,
			f.ou_id as ouId,
			f.status as status,
			f.batch as batch,
			sys.dic_label as facilityTypeName,
			t.name as outboundboxTypeName,
			g.facility_group_name as facilityGroupName,
			s.priority as priority
		from 
			t_wh_outbound_facility f
			left join sys_dictionary sys on (sys.dic_value = f.facility_type and sys.group_value = 'FACILITY_TYPE')
			left join t_wh_outboundbox_type t on f.outboundbox_type_id = t.id
			left join t_wh_outbound_facility_group g on f.facility_group = g.id 
			left join t_wh_outbound_facility_sortorder s on (s.facility_id = f.id and s.facility_type = f.facility_type)
		where 
			f.ou_id = #{ouId}
			and f.id = #{id}
	</select>
	
	<delete id="deleteByIdAndOuId">
		delete from t_wh_outbound_facility 
		where
			id = #{id}
			and ou_id = #{ouId} 
	</delete>
	
	<update id="updateFacilityGroupIsNull">
		update
			t_wh_outbound_facility
		set 
			facility_group = null
		where 
			facility_group = #{groupId}
			and ou_id = #{ouId}
	</update>
	
	<select id="findUseableFacilityList" resultMap="WhOutboundFacilityResultExt">
		select 
			<include refid="whOutboundFacilityColumnsExt"/>    
		from 
			t_wh_outbound_facility 
		where 
			facility_type = #{type}
			and ou_id = #{ouId}
			and facility_group is null
			and lifecycle = 1
	</select>
	
	<select id="getTopFreeOutBoundFacilityByFacilityGroupId" resultMap="WhOutboundFacilityResultExt">
		select 
			f.id as id,
            f.facility_code as facilityCode,
            f.facility_name as facilityName,
            f.facility_type as facilityType,
            f.outboundbox_type_id as outboundboxTypeId,
            f.capacity as capacity,
            f.facility_lower_limit as facilityLowerLimit,
            f.facility_upper_limit as facilityUpperLimit,
            f.facility_group as facilityGroup,
            f.check_code as checkCode,
            f.create_time as createTime,
            f.last_modify_time as lastModifyTime,
            f.operator_id as operatorId,
            f.lifecycle as lifecycle,
            f.status as status,
            f.ou_id as ouId    
		from t_wh_outbound_facility f
		inner join t_wh_outbound_facility_group g on f.facility_group=g.id
		left join t_wh_outbound_facility_sortorder s on s.facility_id=f.id and s.facility_type=f.facility_type
		where f.`status`='1' and f.lifecycle = 1 and g.id=#{facilityGroupId} and f.ou_id=#{ouId}
		order by s.priority
		limit 1
	</select>

	<select id="getSeedingFacility" resultMap="WhOutboundFacilityCommand">
		select
			<include refid="whOutboundFacilityColumnsExt"/>
		from
			t_wh_outbound_facility f 
		where 
			f.status in ('2','3')
			and EXISTS (select id from t_wh_seeding_collection c where c.batch = f.batch and c.temporary_location_id is not null)
			and f.ou_id = #{ouId}
	</select>
	
	<select id="findByCodeAndOuId" resultMap="WhOutboundFacilityResultExt">
		select
			<include refid="whOutboundFacilityColumnsExt"/>
		from
			t_wh_outbound_facility f 
		where 
			f.facility_code = #{facilityCode}
			and f.ou_id = #{ouId}
	</select>

    <select id="getOutboundFacilityByCode" resultMap="WhOutboundFacilityCommand">
        select
        <include refid="whOutboundFacilityColumnsExt"/>
        from
        t_wh_outbound_facility
        <where>
            <if test="ouId!=null and ouId!=''">
                and ou_id = #{ouId}
            </if>
            <if test="facilityCheckCode != null and facilityCheckCode != ''">
                and check_code = #{facilityCheckCode}
            </if>
            <if test="facilityCode!=null and facilityCode!=''">
                and facility_code = #{facilityCode}
            </if>
        </where>
    </select>
    
    <select id="findBoundFacilityByCode" resultMap="WhOutboundFacilityResultExt">
		select 
			<include refid="whOutboundFacilityColumnsExt"/>    
		from 
			t_wh_outbound_facility
		<where>
            <if test="ouId!=null and ouId!=''">
                and ou_id = #{ouId}
            </if>
            <if test="checkCode != null and checkCode != ''">
                and check_code = #{checkCode}
            </if>
            <if test="facilityCode!=null and facilityCode!=''">
                and facility_code = #{facilityCode}
            </if>
		</where>	
	</select>

</mapper>
