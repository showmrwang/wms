<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="com.baozun.scm.primservice.whoperation.dao.warehouse.WhFacilityRecPathDao">
    <resultMap id="WhFacilityRecPathResultExt" type="com.baozun.scm.primservice.whoperation.model.warehouse.WhFacilityRecPath">
    </resultMap>
    <resultMap id="WhFacilityRecPathCommand" type="com.baozun.scm.primservice.whoperation.command.warehouse.WhFacilityRecPathCommand">
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="whFacilityRecPathColumnsExt">
        <![CDATA[
                id as id,
                batch as batch,
                container_code as containerCode,
                seedingwall_code as seedingwallCode,
                seedingwall_upper_limit as seedingwallUpperLimit,
                seedingwall_check_code as seedingwallCheckCode,
                temporary_storage_location_code as temporaryStorageLocationCode,
                temporary_storage_location_check_code as temporaryStorageLocationCheckCode,
                transit_location_code as transitLocationCode,
                transit_location_check_code as transitLocationCheckCode,
                status as status,
                ou_id as ouId,
                batch_container_qty as batchContainerQty
        ]]>
    </sql>

    <sql id="whFacilityRecPathDynamicWhereExt">
        <!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
        <where>

            <if test="id!=null">
                and id = #{id}
            </if>


            <if test="batch!=null and batch!=''">
                and batch = #{batch}
            </if>


            <if test="containerCode!=null and containerCode!=''">
                and container_code = #{containerCode}
            </if>


            <if test="seedingwallCode!=null and seedingwallCode!=''">
                and seedingwall_code = #{seedingwallCode}
            </if>

            <if test="seedingwallUpperLimit!=null">
                and seedingwall_upper_limit = #{seedingwallUpperLimit}
            </if>


            <if test="seedingwallCheckCode!=null and seedingwallCheckCode!=''">
                and seedingwall_check_code = #{seedingwallCheckCode}
            </if>


            <if test="temporaryStorageLocationCode!=null and temporaryStorageLocationCode!=''">
                and temporary_storage_location_code = #{temporaryStorageLocationCode}
            </if>


            <if test="temporaryStorageLocationCheckCode!=null and temporaryStorageLocationCheckCode!=''">
                and temporary_storage_location_check_code = #{temporaryStorageLocationCheckCode}
            </if>


            <if test="transitLocationCode!=null and transitLocationCode!=''">
                and transit_location_code = #{transitLocationCode}
            </if>


            <if test="transitLocationCheckCode!=null and transitLocationCheckCode!=''">
                and transit_location_check_code = #{transitLocationCheckCode}
            </if>

            <if test="status!=null">
                and status = #{status}
            </if>

            <if test="ouId!=null">
                and ou_id = #{ouId}
            </if>

            <if test="batchContainerQty!=null">
                and batch_container_qty = #{batchContainerQty}
            </if>
        </where>
    </sql>
	
	<select id="getRecommendResultByContainerCode" resultMap="WhFacilityRecPathCommand">
		select 
			p.id as id,
			p.batch as batch,
			p.container_code as containerCode,
			p.seedingwall_code as seedingwallCode,
			p.seedingwall_upper_limit as seedingwallUpperLimit,
			p.seedingwall_check_code as seedingwallCheckCode,
			p.temporary_storage_location_code as temporaryStorageLocationCode,
			p.temporary_storage_location_check_code as temporaryStorageLocationCheckCode,
			p.transit_location_code as transitLocationCode,
			p.transit_location_check_code as transitLocationCheckCode,
			p.status as status,
			p.ou_id as ouId,
			p.batch_container_qty as batchContainerQty,
			f.id as facilityId,
			l.id as temporaryStorageLocationId,
			loc.id as transitLocationId,
			c.id as containerId
		from 
			t_wh_facility_rec_path p 
			left join t_wh_outbound_facility f on f.facility_code = p.seedingwall_code
			left join t_wh_temporary_storage_location l on l.temporary_storage_code = p.temporary_storage_location_code
			left join t_wh_location loc on loc.code = p.transit_location_code
			left join t_wh_container c on c.code = p.container_code
		where 
			p.container_code = #{containerCode}
			<if test="batch != null and batch != ''">
				and p.batch = #{batch}
			</if>
			and p.status = 1
			and p.ou_id = #{ouId}
	</select>
	
	<select id="findTemporaryStorageLocationCodeByBatch" resultType="string">
		select 
			p.temporary_storage_location_code
		from 
			t_wh_facility_rec_path p 
		where  
			p.batch = #{batch}
			and p.status = 1
			and p.ou_id = #{ouId}
		group by 
			p.temporary_storage_location_code
	</select>
    
    
    <select id="findWhFacilityRecPathByBatchAndContainer" resultMap="WhFacilityRecPathResultExt">
        select
        <include refid="whFacilityRecPathColumnsExt"/>
        from t_wh_facility_rec_path
       	where
       		batch = #{batch}
       		and ou_id = #{ouId}
       		and container_code = #{containerCode}
    </select>
	
	<select id="getRecommendDestinationByBatch" resultMap="WhFacilityRecPathResultExt">
		select
			p.seedingwall_code as seedingwallCode,
			p.temporary_storage_location_code as temporaryStorageLocationCode,
			p.transit_location_code as transitLocationCode
		from
			t_wh_facility_rec_path p
		where
			p.batch = #{batch}
			and p.status = 1
			and p.ou_id = #{ouId}
		group by
			p.seedingwall_code,
			p.temporary_storage_location_code,
			p.transit_location_code as transitLocationCode
	</select>
	
	<select id="getBatchListByDestinationCode" resultType="string">
		select
			p.batch
		from
			t_wh_facility_rec_path p
		where
			p.status = 1
			<if test="destinationType == 1">
				and p.seedingwall_code = #{destinationCode}
			</if>
			<if test="destinationType == 2">
				and p.temporary_storage_location_code = #{destinationCode}
			</if>
			<if test="destinationType == 3">
				and p.transit_location_code = #{destinationCode}
			</if>
			and p.ou_id = #{ouId}
		group by
			p.batch
	</select>
</mapper>
