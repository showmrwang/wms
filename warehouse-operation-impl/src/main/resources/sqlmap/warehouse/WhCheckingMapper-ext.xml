<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="com.baozun.scm.primservice.whoperation.dao.warehouse.WhCheckingDao">
    <resultMap id="WhCheckingResultExt" type="com.baozun.scm.primservice.whoperation.model.warehouse.WhChecking">
    </resultMap>

    <resultMap id="WhCheckingCommand" type="com.baozun.scm.primservice.whoperation.command.warehouse.WhCheckingCommand">
    </resultMap>

    <resultMap id="WeightingCommand" type="com.baozun.scm.primservice.whoperation.command.warehouse.WeightingCommand">
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="whCheckingColumnsExt">
        <![CDATA[
                id as id,
                facility_id as facilityId,
                container_id as containerId,
                batch as batch,
                wave_code as waveCode,
                customer_code as customerCode,
                customer_name as customerName,
                store_code as storeCode,
                store_name as storeName,
                transport_code as transportCode,
                transport_name as transportName,
                product_code as productCode,
                product_name as productName,
                time_effect_code as timeEffectCode,
                time_effect_name as timeEffectName,
                status as status,
                ou_id as ouId,
                outer_container_id as outerContainerId,
                container_lattice_no as containerLatticeNo,
                outboundbox_id as outboundboxId,
                outboundbox_code as outboundboxCode,
                distribution_mode as distributionMode,
                picking_mode as pickingMode,
                checking_mode as checkingMode,
                create_id as createId,
                create_time as createTime,
	        	last_modify_time as lastModifyTime,
	        	modified_id as modifiedId
        ]]>
    </sql>

    <sql id="whCheckWeightingExt">
        <![CDATA[
                ch.id as id,
                ch.facility_id as facilityId,
                ch.container_id as containerId,
                ch.batch as batch,
                ch.wave_code as waveCode,
                ch.customer_code as customerCode,
                ch.customer_name as customerName,
                ch.store_code as storeCode,
                ch.store_name as storeName,
                ch.transport_code as transportCode,
                ch.transport_name as transportName,
                ch.product_code as productCode,
                ch.product_name as productName,
                ch.time_effect_code as timeEffectCode,
                ch.time_effect_name as timeEffectName,
                ch.status as status,
                ch.ou_id as ouId,
                ch.outer_container_id as outerContainerId,
                ch.container_lattice_no as containerLatticeNo,
                ch.outboundbox_id as outboundboxId,
                ch.outboundbox_code as outboundboxCode,
                ch.distribution_mode as distributionMode,
                ch.picking_mode as pickingMode,
                ch.last_modify_time as lastModifyTime,
                ch.create_id as createId,
                ch.create_time as createTime,
                ch.modified_id as modifiedId,
                ch.checking_mode as checkingMode
        ]]>
    </sql>

    <sql id="whCheckingDynamicWhereExt">
        <!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
        <where>

            <if test="id!=null">
                and id = #{id}
            </if>

            <if test="facilityId!=null">
                and facility_id = #{facilityId}
            </if>

            <if test="containerId!=null">
                and container_id = #{containerId}
            </if>


            <if test="batch!=null and batch!=''">
                and batch = #{batch}
            </if>


            <if test="waveCode!=null and waveCode!=''">
                and wave_code = #{waveCode}
            </if>


            <if test="customerCode!=null and customerCode!=''">
                and customer_code = #{customerCode}
            </if>


            <if test="customerName!=null and customerName!=''">
                and customer_name = #{customerName}
            </if>


            <if test="storeCode!=null and storeCode!=''">
                and store_code = #{storeCode}
            </if>


            <if test="storeName!=null and storeName!=''">
                and store_name = #{storeName}
            </if>


            <if test="transportCode!=null and transportCode!=''">
                and transport_code = #{transportCode}
            </if>


            <if test="transportName!=null and transportName!=''">
                and transport_name = #{transportName}
            </if>


            <if test="productCode!=null and productCode!=''">
                and product_code = #{productCode}
            </if>


            <if test="productName!=null and productName!=''">
                and product_name = #{productName}
            </if>


            <if test="timeEffectCode!=null and timeEffectCode!=''">
                and time_effect_code = #{timeEffectCode}
            </if>


            <if test="timeEffectName!=null and timeEffectName!=''">
                and time_effect_name = #{timeEffectName}
            </if>

            <if test="status!=null">
                and status = #{status}
            </if>

            <if test="ouId!=null">
                and ou_id = #{ouId}
            </if>

            <if test="outerContainerId!=null">
                and outer_container_id = #{outerContainerId}
            </if>

            <if test="containerLatticeNo!=null">
                and container_lattice_no = #{containerLatticeNo}
            </if>

            <if test="outboundboxId!=null">
                and outboundbox_id = #{outboundboxId}
            </if>


            <if test="outboundboxCode!=null and outboundboxCode!=''">
                and outboundbox_code = #{outboundboxCode}
            </if>


            <if test="distributionMode!=null and distributionMode!=''">
                and distribution_mode = #{distributionMode}
            </if>


            <if test="pickingMode!=null and pickingMode!=''">
                and picking_mode = #{pickingMode}
            </if>


            <if test="checkingMode!=null and checkingMode!=''">
                and checking_mode = #{checkingMode}
            </if>
            
            <if test="createTime!=null">
					and create_time = #{createTime}
				</if>
	       
				<if test="lastModifyTime!=null">
					and last_modify_time = #{lastModifyTime}
				</if>
	       
				<if test="createId!=null">
					and create_id = #{createId}
				</if>
	       
				<if test="modifiedId!=null">
					and modified_id = #{modifiedId}
				</if>
        </where>
    </sql>
    
    
     <select id="findByWaybillCode" resultMap="WeightingCommand" flushCache="false">
        SELECT
			info.outboundbox_code AS outboundboxCode,
			pack.calc_weight AS calcWeighting,
			pack.floats AS floats,
			odo.id AS odoId,
			odo.odo_code AS odoCode,
			box.wave_code AS waveCode,
			box.batch AS batch,
			info.transport_code AS transportCode,
			info.waybill_code AS waybillCode,
			consumable.sku_barcode AS skuCode,
			box.customer_name AS customerName,
			box.store_name AS storeName
		FROM
			t_wh_odo_delivery_info info
		LEFT JOIN t_wh_outboundbox box ON info.outboundbox_code = box.outboundbox_code
		AND info.odo_id = box.odo_id
		LEFT JOIN t_wh_odo odo ON info.odo_id = odo.id
		LEFT JOIN t_wh_odo_package_info pack ON pack.outboundbox_code = info.outboundbox_code
		LEFT JOIN t_wh_outbound_consumable consumable ON consumable.outboundbox_code = info.outboundbox_code
		WHERE
			info.waybill_code = #{waybillCode}
			AND info.ou_id = #{ouId}
			and box.status in ('1', '8')
			LIMIT 1
    </select>

     <select id="findByOutboundBoxCode" resultMap="WeightingCommand" flushCache="false">
        select
        info.actual_weight as actualWeight,
		info.calc_weight as calcWeighting,
		info.floats as floats,
		odo.odo_code as odoCode,
		odo.id as odoId,
		info.outboundbox_id as outboundBoxId,
		del.waybill_code as waybillCode,
		sku.bar_code as skuCode,
        <include refid="whCheckWeightingExt"/>
        from t_wh_checking ch 
        left join t_wh_checking_line line on ch.id = line.checking_id
        left join t_wh_odo_package_info info on line.outboundbox_code = info.outboundbox_code
		left join t_wh_odo odo on info.odo_id = odo.id
		left join t_wh_odo_delivery_info del on line.outboundbox_code = del.outboundbox_code
		left join t_wh_sku sku on line.outboundbox_id = sku.id
		where line.outboundbox_code = #{outboundBoxCode} and ch.ou_id = #{ouId}
		limit 1
    </select>

     <select id="findByOutboundBoxCodeAndCheckingId" resultMap="WeightingCommand" flushCache="false">
        select
        info.actual_weight as actualWeight,
		info.calc_weight as calcWeight,
		info.floats as floats,
		odo.odo_code as odoCode,
		odo.id as odoId,
		info.outboundbox_id as outboundBoxId,
		del.waybill_code as waybillCode,
		sku.bar_code as skuCode,
        <include refid="whCheckWeightingExt"/>
        FROM
			t_wh_checking ch,
			t_wh_odo_package_info info,
			t_wh_odo odo,
			t_wh_odo_delivery_info del,
			t_wh_sku sku
		WHERE
			ch.id = #{checkingId}
		and odo.id = info.odo_id
		AND info.outboundbox_code = #{outboundBoxCode}
		and del.outboundbox_code = #{outboundBoxCode}
		and del.outboundbox_id = #{outboundboxId}
		and  ch.outboundbox_id = sku.id
		AND ch.ou_id = #{ouId};
    </select>

     <select id="findListByFacilityCode" resultMap="WhCheckingCommand" flushCache="false">
        select
	       	 ch.id as id,
	         ch.facility_id as facilityId,
	         ch.container_id as containerId,
	         ch.batch as batch,
	         ch.wave_code as waveCode,
	         ch.customer_code as customerCode,
	         ch.customer_name as customerName,
	         ch.store_code as storeCode,
	         ch.store_name as storeName,
	         ch.transport_code as transportCode,
	         ch.transport_name as transportName,
	         ch.product_code as productCode,
	         ch.product_name as productName,
	         ch.time_effect_code as timeEffectCode,
	         ch.time_effect_name as timeEffectName,
	         ch.status as status,
	         ch.ou_id as ouId,
	         ch.outer_container_id as outerContainerId,
	         ch.container_lattice_no as containerLatticeNo,
	         ch.outboundbox_id as outboundboxId,
	         ch.outboundbox_code as outboundboxCode,
	         ch.distribution_mode as distributionMode,
	         ch.picking_mode as pickingMode,
            ch.last_modify_time as lastModifyTime,
            ch.create_id as createId,
            ch.create_time as createTime,
            ch.modified_id as modifiedId,
	         ch.checking_mode as checkingMode
        from t_wh_checking ch left join t_wh_outbound_facility facility on ch.facility_id = facility.id
		where facility.facility_code = #{facilityCode}
			and facility.facility_type = "seedingWall"
			and ch.ou_id = #{ouId}
			and facility.lifecycle = 1
			and ch.status != 10
    </select>
    
    <sql id="whCheckingCommandColumnsExt">
        <![CDATA[
                checking.id as id,
                checking.facility_id as facilityId,
                checking.container_id as containerId,
                checking.batch as batch,
                checking.wave_code as waveCode,
                checking.customer_code as customerCode,
                checking.customer_name as customerName,
                checking.store_code as storeCode,
                checking.store_name as storeName,
                checking.transport_code as transportCode,
                checking.transport_name as transportName,
                checking.product_code as productCode,
                checking.product_name as productName,
                checking.time_effect_code as timeEffectCode,
                checking.time_effect_name as timeEffectName,
                checking.status as status,
                checking.ou_id as ouId,
                checking.outer_container_id as outerContainerId,
                checking.container_lattice_no as containerLatticeNo,
                checking.outboundbox_id as outboundboxId,
                checking.outboundbox_code as outboundboxCode,
                checking.distribution_mode as distributionMode,
                checking.picking_mode as pickingMode,
                checking.checking_mode as checkingMode,
                checking.last_modify_time as lastModifyTime,
                checking.create_id as createId,
                checking.create_time as createTime,
                checking.modified_id as modifiedId,
                sku.bar_code as consumableSkuBarcode
        ]]>
    </sql>
    
    <sql id="whCheckingCommandDynamicWhereExt">
        <!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
        <where>
			checking.status != 10
            <if test="id!=null">
                and checking.id = #{id}
            </if>

            <if test="facilityId!=null">
                and checking.facility_id = #{facilityId}
            </if>

            <if test="containerId!=null">
                and checking.container_id = #{containerId}
            </if>


            <if test="batch!=null and batch!=''">
                and checking.batch = #{batch}
            </if>


            <if test="waveCode!=null and waveCode!=''">
                and checking.wave_code = #{waveCode}
            </if>


            <if test="customerCode!=null and customerCode!=''">
                and checking.customer_code = #{customerCode}
            </if>


            <if test="customerName!=null and customerName!=''">
                and checking.customer_name = #{customerName}
            </if>


            <if test="storeCode!=null and storeCode!=''">
                and checking.store_code = #{storeCode}
            </if>


            <if test="storeName!=null and storeName!=''">
                and checking.store_name = #{storeName}
            </if>


            <if test="transportCode!=null and transportCode!=''">
                and checking.transport_code = #{transportCode}
            </if>


            <if test="transportName!=null and transportName!=''">
                and checking.transport_name = #{transportName}
            </if>


            <if test="productCode!=null and productCode!=''">
                and checking.product_code = #{productCode}
            </if>


            <if test="productName!=null and productName!=''">
                and checking.product_name = #{productName}
            </if>


            <if test="timeEffectCode!=null and timeEffectCode!=''">
                and checking.time_effect_code = #{timeEffectCode}
            </if>


            <if test="timeEffectName!=null and timeEffectName!=''">
                and checking.time_effect_name = #{timeEffectName}
            </if>

            <if test="status!=null">
                and checking.status = #{status}
            </if>

            <if test="ouId!=null">
                and checking.ou_id = #{ouId}
            </if>

            <if test="outerContainerId!=null">
                and checking.outer_container_id = #{outerContainerId}
            </if>

            <if test="containerLatticeNo!=null">
                and checking.container_lattice_no = #{containerLatticeNo}
            </if>

            <if test="outboundboxId!=null">
                and checking.outboundbox_id = #{outboundboxId}
            </if>


            <if test="outboundboxCode!=null and outboundboxCode!=''">
                and checking.outboundbox_code = #{outboundboxCode}
            </if>


            <if test="distributionMode!=null and distributionMode!=''">
                and checking.distribution_mode = #{distributionMode}
            </if>


            <if test="pickingMode!=null and pickingMode!=''">
                and checking.picking_mode = #{pickingMode}
            </if>


            <if test="checkingMode!=null and checkingMode!=''">
                and checking.checking_mode = #{checkingMode}
            </if>
        </where>
    </sql>
    
    <select id="findListByParamExt" resultMap="WhCheckingCommand">
        select
        <include refid="whCheckingCommandColumnsExt"/>
        from t_wh_checking checking left join t_wh_sku sku on checking.outboundbox_id = sku.id
        <include refid="whCheckingCommandDynamicWhereExt"/>
    </select>
    
     <select id="findWhCheckingCommandByIdExt" resultMap="WhCheckingCommand">
        select
        <include refid="whCheckingColumnsExt"/>
        from t_wh_checking 
        where id = #{id}
         and ou_id = #{ouId}
    </select>

    <select id="findWhCheckingByIdExt" resultMap="WhCheckingResultExt">
        select
          <include refid="whCheckingColumnsExt"/>
        from t_wh_checking
        where id = #{id}
          and ou_id = #{ouId}
    </select>

     <select id="findListByOuterContainerCode" resultMap="WhCheckingCommand">
        select
        ch.id as id,
	         ch.facility_id as facilityId,
	         ch.container_id as containerId,
	         ch.batch as batch,
	         ch.wave_code as waveCode,
	         ch.customer_code as customerCode,
	         ch.customer_name as customerName,
	         ch.store_code as storeCode,
	         ch.store_name as storeName,
	         ch.transport_code as transportCode,
	         ch.transport_name as transportName,
	         ch.product_code as productCode,
	         ch.product_name as productName,
	         ch.time_effect_code as timeEffectCode,
	         ch.time_effect_name as timeEffectName,
	         ch.status as status,
	         ch.ou_id as ouId,
	         ch.outer_container_id as outerContainerId,
	         ch.container_lattice_no as containerLatticeNo,
	         ch.outboundbox_id as outboundboxId,
	         ch.outboundbox_code as outboundboxCode,
	         ch.distribution_mode as distributionMode,
	         ch.picking_mode as pickingMode,
            ch.last_modify_time as lastModifyTime,
             ch.create_id as createId,
             ch.create_time as createTime,
             ch.modified_id as modifiedId,
	         ch.checking_mode as checkingMode
        from t_wh_checking ch left join t_wh_container container on ch.outer_container_id = container.id
        where ch.ou_id = #{ouId}
        and container.code = #{outerContainerCode}
        and ch.status != 10
    </select>

     <select id="findListByContainerCode" resultMap="WhCheckingCommand">
        select
        ch.id as id,
	         ch.facility_id as facilityId,
	         ch.container_id as containerId,
	         ch.batch as batch,
	         ch.wave_code as waveCode,
	         ch.customer_code as customerCode,
	         ch.customer_name as customerName,
	         ch.store_code as storeCode,
	         ch.store_name as storeName,
	         ch.transport_code as transportCode,
	         ch.transport_name as transportName,
	         ch.product_code as productCode,
	         ch.product_name as productName,
	         ch.time_effect_code as timeEffectCode,
	         ch.time_effect_name as timeEffectName,
	         ch.status as status,
	         ch.ou_id as ouId,
	         ch.outer_container_id as outerContainerId,
	         ch.container_lattice_no as containerLatticeNo,
	         ch.outboundbox_id as outboundboxId,
	         ch.outboundbox_code as outboundboxCode,
	         ch.distribution_mode as distributionMode,
	         ch.picking_mode as pickingMode,
	         ch.checking_mode as checkingMode,
            ch.last_modify_time as lastModifyTime,
             ch.create_id as createId,
             ch.create_time as createTime,
             ch.modified_id as modifiedId,
	         container.code as containerCode
        from t_wh_checking ch left join t_wh_container container on ch.container_id = container.id
        where ch.ou_id = #{ouId}
        and container.code = #{containerCode}
        and ch.status != 10
    </select>

     <select id="findCheckingInfoByBatchAndOuId" resultMap="WhCheckingCommand">
        select
        ch.id as id,
	         ch.facility_id as facilityId,
	         ch.container_id as containerId,
	         ch.batch as batch,
	         ch.wave_code as waveCode,
	         ch.customer_code as customerCode,
	         ch.customer_name as customerName,
	         ch.store_code as storeCode,
	         ch.store_name as storeName,
	         ch.transport_code as transportCode,
	         ch.transport_name as transportName,
	         ch.product_code as productCode,
	         ch.product_name as productName,
	         ch.time_effect_code as timeEffectCode,
	         ch.time_effect_name as timeEffectName,
	         ch.status as status,
	         ch.ou_id as ouId,
	         ch.outer_container_id as outerContainerId,
	         ch.container_lattice_no as containerLatticeNo,
	         ch.outboundbox_id as outboundboxId,
	         ch.outboundbox_code as outboundboxCode,
	         ch.distribution_mode as distributionMode,
	         ch.picking_mode as pickingMode,
	         ch.checking_mode as checkingMode,
            ch.last_modify_time as lastModifyTime,
             ch.create_id as createId,
             ch.create_time as createTime,
             ch.modified_id as modifiedId,
	         container.code as containerCode
        from t_wh_checking ch left join t_wh_container container on ch.container_id = container.id
        where ch.ou_id = #{ouId}
        and container.code = #{containerCode}
    </select>
    

    <update id="updateByVersion" parameterType="com.baozun.scm.primservice.whoperation.model.warehouse.WhChecking">
        <![CDATA[
            UPDATE t_wh_checking SET
                facility_id = #{facilityId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                container_id = #{containerId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                batch = #{batch,javaType=java.lang.String,jdbcType=VARCHAR} ,
                wave_code = #{waveCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                customer_code = #{customerCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                customer_name = #{customerName,javaType=java.lang.String,jdbcType=VARCHAR} ,
                store_code = #{storeCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                store_name = #{storeName,javaType=java.lang.String,jdbcType=VARCHAR} ,
                transport_code = #{transportCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                transport_name = #{transportName,javaType=java.lang.String,jdbcType=VARCHAR} ,
                product_code = #{productCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                product_name = #{productName,javaType=java.lang.String,jdbcType=VARCHAR} ,
                time_effect_code = #{timeEffectCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                time_effect_name = #{timeEffectName,javaType=java.lang.String,jdbcType=VARCHAR} ,
                status = #{status,javaType=java.lang.Integer,jdbcType=INTEGER} ,
                outer_container_id = #{outerContainerId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                container_lattice_no = #{containerLatticeNo,javaType=java.lang.Integer,jdbcType=INTEGER} ,
                outboundbox_id = #{outboundboxId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                outboundbox_code = #{outboundboxCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                distribution_mode = #{distributionMode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                picking_mode = #{pickingMode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                checking_mode = #{checkingMode,javaType=java.lang.String,jdbcType=VARCHAR} ,
		        create_id = #{createId,javaType=java.lang.Long,jdbcType=BIGINT} , 
                create_time = #{createTime,javaType=java.util.Date,jdbcType=TIMESTAMP} , 
		        last_modify_time = now(),
		        modified_id = #{modifiedId,javaType=java.lang.Long,jdbcType=BIGINT} 
            WHERE 
                id = #{id} and ou_id=#{ouId}
                and last_modify_time	=  #{lastModifyTime}  
        ]]>
    </update>
    


     <select id="findWhCheckingByOutboundboxCode" resultMap="WhCheckingCommand">
        select
        <include refid="whCheckingColumnsExt"/>
        from t_wh_checking 
        where outboundbox_code = #{outboundboxCode}
         and ou_id = #{ouId}
    </select>



    <select id="findCheckingBySourceCode" resultMap="WhCheckingCommand">
        SELECT
            checking.id AS id,
            checking.facility_id AS facilityId,
            checking.container_id AS containerId,
            checking.batch AS batch,
            checking.wave_code AS waveCode,
            checking.customer_code AS customerCode,
            checking.customer_name AS customerName,
            checking.store_code AS storeCode,
            checking.store_name AS storeName,
            checking.transport_code AS transportCode,
            checking.transport_name AS transportName,
            checking.product_code AS productCode,
            checking.product_name AS productName,
            checking.time_effect_code AS timeEffectCode,
            checking.time_effect_name AS timeEffectName,
            checking.status AS status,
            checking.ou_id AS ouId,
            checking.outer_container_id AS outerContainerId,
            checking.container_lattice_no AS containerLatticeNo,
            checking.outboundbox_id AS outboundboxId,
            checking.outboundbox_code AS outboundboxCode,
            checking.distribution_mode AS distributionMode,
            checking.picking_mode AS pickingMode,
            checking.checking_mode AS checkingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            facility.facility_code AS facilityCode,
            turnoverBox.code AS containerCode,
            trolley.code AS outContainerCode
        FROM
            t_wh_checking AS checking
            LEFT JOIN t_wh_outbound_facility AS facility ON checking.facility_id = facility.id
            LEFT JOIN t_wh_container AS turnoverBox ON checking.container_id = turnoverBox.id
            LEFT JOIN t_wh_container AS trolley ON checking.outer_container_id = trolley.id
        WHERE
            checking.ou_id = #{ouId}
        AND (
            facility.facility_code = #{checkingSourceCode}
            OR turnoverBox.code = #{checkingSourceCode}
            OR trolley.code = #{checkingSourceCode}
            OR checking.container_lattice_no = #{checkingSourceCode}
            OR checking.outboundbox_code = #{checkingSourceCode}
        )
        and ( checking.status = 1 or checking.status = 9)

    </select>

    <select id="findCheckingByBoxCode" resultMap="WhCheckingCommand">
        SELECT
            checking.id AS id,
            checking.facility_id AS facilityId,
            checking.container_id AS containerId,
            checking.batch AS batch,
            checking.wave_code AS waveCode,
            checking.customer_code AS customerCode,
            checking.customer_name AS customerName,
            checking.store_code AS storeCode,
            checking.store_name AS storeName,
            checking.transport_code AS transportCode,
            checking.transport_name AS transportName,
            checking.product_code AS productCode,
            checking.product_name AS productName,
            checking.time_effect_code AS timeEffectCode,
            checking.time_effect_name AS timeEffectName,
            checking.status AS status,
            checking.ou_id AS ouId,
            checking.outer_container_id AS outerContainerId,
            checking.container_lattice_no AS containerLatticeNo,
            checking.outboundbox_id AS outboundboxId,
            checking.outboundbox_code AS outboundboxCode,
            checking.distribution_mode AS distributionMode,
            checking.picking_mode AS pickingMode,
            checking.checking_mode AS checkingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            facility.facility_code AS facilityCode,
            turnoverBox.code AS containerCode,
            trolley.code AS outContainerCode
        FROM
            t_wh_checking AS checking
            LEFT JOIN t_wh_outbound_facility AS facility ON checking.facility_id = facility.id
            LEFT JOIN t_wh_container AS turnoverBox ON checking.container_id = turnoverBox.id
            LEFT JOIN t_wh_container AS trolley ON checking.outer_container_id = trolley.id
        WHERE
            checking.ou_id = #{ouId}
            AND (
                facility.facility_code = #{checkingSourceCode}
                OR trolley.code = #{checkingSourceCode}
            )
            and(
                 checking.container_lattice_no = #{checkingBoxCode}
                OR checking.outboundbox_code = #{checkingBoxCode}
            )
            and ( checking.status = 1 or checking.status = 9)
    </select>

    <select id="findCheckingByParam" resultMap="WhCheckingCommand">
        select
            checking.id as id,
            checking.facility_id as facilityId,
            checking.container_id as containerId,
            checking.batch as batch,
            checking.wave_code as waveCode,
            checking.customer_code as customerCode,
            checking.customer_name as customerName,
            checking.store_code as storeCode,
            checking.store_name as storeName,
            checking.transport_code as transportCode,
            checking.transport_name as transportName,
            checking.product_code as productCode,
            checking.product_name as productName,
            checking.time_effect_code as timeEffectCode,
            checking.time_effect_name as timeEffectName,
            checking.status as status,
            checking.ou_id as ouId,
            checking.outer_container_id as outerContainerId,
            checking.container_lattice_no as containerLatticeNo,
            checking.outboundbox_id as outboundboxId,
            checking.outboundbox_code as outboundboxCode,
            checking.distribution_mode as distributionMode,
            checking.picking_mode as pickingMode,
            checking.checking_mode as checkingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            outboundFac.facility_code as facilityCode,
            container.code as containerCode,
            outContainer.code as outContainerCode
        from t_wh_checking as checking
            left join t_wh_outbound_facility as outboundFac on checking.facility_id = outboundFac.id
            left join t_wh_container as container on checking.container_id = container.id
            left join t_wh_container as outContainer on checking.outer_container_id = outContainer.id
        <where>
            <if test="id!=null">
                and checking.id = #{id}
            </if>
            <if test="ouId!=null">
                and checking.ou_id = #{ouId}
            </if>
            <if test="facilityCode != null and facilityCode != ''">
                and outboundFac.facility_code = #{facilityCode}
            </if>
            <if test="containerCode != null and containerCode != ''">
                and container.code = #{containerCode}
            </if>
            <if test="outContainerCode != null and outContainerCode != ''">
                and outContainer.code = #{outContainerCode}
            </if>
            <if test="containerLatticeNo != null and containerLatticeNo != ''">
                and checking.container_lattice_no = #{containerLatticeNo}
            </if>
            <if test="outboundboxCode != null and outboundboxCode != ''">
                and checking.outboundbox_code = #{outboundboxCode}
            </if>
        </where>
    </select>

    <select id="findCheckingByBatch" resultMap="WhCheckingCommand">
        select
            <include refid="whCheckingColumnsExt"/>
        from t_wh_checking
        where batch = #{batchNo}
        and ou_id = #{ouId}
    </select>

    <select id="getCheckingOdoQtyByBatch" resultType="java.lang.Integer">
        select
            count(distinct checkingLine.odo_id)
        from
            t_wh_checking as checking
            left join t_wh_checking_line as checkingLine on checkingLine.checking_id = checking.id
        where checking.batch = #{batchNo}
        and checking.ou_id = #{ouId}
    </select>

    <select id="findCheckingByTrolley"  resultMap="WhCheckingCommand">
        SELECT
            checking.id AS id,
            checking.facility_id AS facilityId,
            checking.container_id AS containerId,
            checking.batch AS batch,
            checking.wave_code AS waveCode,
            checking.customer_code AS customerCode,
            checking.customer_name AS customerName,
            checking.store_code AS storeCode,
            checking.store_name AS storeName,
            checking.transport_code AS transportCode,
            checking.transport_name AS transportName,
            checking.product_code AS productCode,
            checking.product_name AS productName,
            checking.time_effect_code AS timeEffectCode,
            checking.time_effect_name AS timeEffectName,
            checking.status AS status,
            checking.ou_id AS ouId,
            checking.outer_container_id AS outerContainerId,
            checking.container_lattice_no AS containerLatticeNo,
            checking.outboundbox_id AS outboundboxId,
            checking.outboundbox_code AS outboundboxCode,
            checking.distribution_mode AS distributionMode,
            checking.picking_mode AS pickingMode,
            checking.checking_mode AS checkingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            facility.facility_code AS facilityCode,
            turnoverBox.code AS containerCode,
            trolley.code AS outContainerCode
        FROM
            t_wh_checking AS checking
            LEFT JOIN t_wh_outbound_facility AS facility ON checking.facility_id = facility.id
            LEFT JOIN t_wh_container AS turnoverBox ON checking.container_id = turnoverBox.id
            LEFT JOIN t_wh_container AS trolley ON checking.outer_container_id = trolley.id
        WHERE
            checking.ou_id = #{ouId}
            AND trolley.code = #{trolleyCode}
    </select>

    <select id="findCheckingByOdo"  resultMap="WhCheckingCommand">
        SELECT
            checking.id AS id,
            checking.facility_id AS facilityId,
            checking.container_id AS containerId,
            checking.batch AS batch,
            checking.wave_code AS waveCode,
            checking.customer_code AS customerCode,
            checking.customer_name AS customerName,
            checking.store_code AS storeCode,
            checking.store_name AS storeName,
            checking.transport_code AS transportCode,
            checking.transport_name AS transportName,
            checking.product_code AS productCode,
            checking.product_name AS productName,
            checking.time_effect_code AS timeEffectCode,
            checking.time_effect_name AS timeEffectName,
            checking.status AS status,
            checking.ou_id AS ouId,
            checking.outer_container_id AS outerContainerId,
            checking.container_lattice_no AS containerLatticeNo,
            checking.outboundbox_id AS outboundboxId,
            checking.outboundbox_code AS outboundboxCode,
            checking.distribution_mode AS distributionMode,
            checking.picking_mode AS pickingMode,
            checking.checking_mode AS checkingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            facility.facility_code AS facilityCode,
            turnoverBox.code AS containerCode,
            trolley.code AS outContainerCode
        FROM
            t_wh_checking AS checking
            LEFT JOIN t_wh_outbound_facility AS facility ON checking.facility_id = facility.id
            LEFT JOIN t_wh_container AS turnoverBox ON checking.container_id = turnoverBox.id
            LEFT JOIN t_wh_container AS trolley ON checking.outer_container_id = trolley.id
        WHERE
            checking.ou_id = #{ouId}
            AND checking.id in (
                                select
                                    distinct checking_id
                                from t_wh_checking_line
                                where
                                    odo_id = #{odoId}
                                    and ou_id = #{ouId}
                                )
    </select>

    <select id="findCheckingBySeedingFacility"  resultMap="WhCheckingCommand">
        SELECT
            checking.id AS id,
            checking.facility_id AS facilityId,
            checking.container_id AS containerId,
            checking.batch AS batch,
            checking.wave_code AS waveCode,
            checking.customer_code AS customerCode,
            checking.customer_name AS customerName,
            checking.store_code AS storeCode,
            checking.store_name AS storeName,
            checking.transport_code AS transportCode,
            checking.transport_name AS transportName,
            checking.product_code AS productCode,
            checking.product_name AS productName,
            checking.time_effect_code AS timeEffectCode,
            checking.time_effect_name AS timeEffectName,
            checking.status AS status,
            checking.ou_id AS ouId,
            checking.outer_container_id AS outerContainerId,
            checking.container_lattice_no AS containerLatticeNo,
            checking.outboundbox_id AS outboundboxId,
            checking.outboundbox_code AS outboundboxCode,
            checking.distribution_mode AS distributionMode,
            checking.picking_mode AS pickingMode,
            checking.checking_mode AS checkingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            facility.facility_code AS facilityCode,
            turnoverBox.code AS containerCode,
            trolley.code AS outContainerCode
        FROM
            t_wh_checking AS checking
            LEFT JOIN t_wh_outbound_facility AS facility ON checking.facility_id = facility.id
            LEFT JOIN t_wh_container AS turnoverBox ON checking.container_id = turnoverBox.id
            LEFT JOIN t_wh_container AS trolley ON checking.outer_container_id = trolley.id
        WHERE
            checking.ou_id = #{ouId}
            AND facility.facility_code = #{facilityCode}
    </select>

    <select id="findCheckingByOutboundBox"  resultMap="WhCheckingCommand">
        SELECT
            checking.id AS id,
            checking.facility_id AS facilityId,
            checking.container_id AS containerId,
            checking.batch AS batch,
            checking.wave_code AS waveCode,
            checking.customer_code AS customerCode,
            checking.customer_name AS customerName,
            checking.store_code AS storeCode,
            checking.store_name AS storeName,
            checking.transport_code AS transportCode,
            checking.transport_name AS transportName,
            checking.product_code AS productCode,
            checking.product_name AS productName,
            checking.time_effect_code AS timeEffectCode,
            checking.time_effect_name AS timeEffectName,
            checking.status AS status,
            checking.ou_id AS ouId,
            checking.outer_container_id AS outerContainerId,
            checking.container_lattice_no AS containerLatticeNo,
            checking.outboundbox_id AS outboundboxId,
            checking.outboundbox_code AS outboundboxCode,
            checking.distribution_mode AS distributionMode,
            checking.picking_mode AS pickingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            checking.checking_mode AS checkingMode
        FROM
            t_wh_checking AS checking
        WHERE
            checking.ou_id = #{ouId}
            and checking.outboundbox_code = #{outboundBoxCode}
    </select>

    <select id="findCheckingByTurnoverBox"  resultMap="WhCheckingCommand">
        SELECT
            checking.id AS id,
            checking.facility_id AS facilityId,
            checking.container_id AS containerId,
            checking.batch AS batch,
            checking.wave_code AS waveCode,
            checking.customer_code AS customerCode,
            checking.customer_name AS customerName,
            checking.store_code AS storeCode,
            checking.store_name AS storeName,
            checking.transport_code AS transportCode,
            checking.transport_name AS transportName,
            checking.product_code AS productCode,
            checking.product_name AS productName,
            checking.time_effect_code AS timeEffectCode,
            checking.time_effect_name AS timeEffectName,
            checking.status AS status,
            checking.ou_id AS ouId,
            checking.outer_container_id AS outerContainerId,
            checking.container_lattice_no AS containerLatticeNo,
            checking.outboundbox_id AS outboundboxId,
            checking.outboundbox_code AS outboundboxCode,
            checking.distribution_mode AS distributionMode,
            checking.picking_mode AS pickingMode,
            checking.checking_mode AS checkingMode,
            checking.last_modify_time as lastModifyTime,
            checking.create_id as createId,
            checking.create_time as createTime,
            checking.modified_id as modifiedId,
            turnoverBox.code AS containerCode
        FROM
            t_wh_checking AS checking
            LEFT JOIN t_wh_container AS turnoverBox ON checking.container_id = turnoverBox.id
        WHERE
            checking.ou_id = #{ouId}
            AND turnoverBox.code = #{turnoverBoxCode}
    </select>
    
    
    <sql id="whCheckingDynamicWhereWithNoFinish">
        <!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
        <where>
			status != 10
            <if test="id!=null">
                and id = #{id}
            </if>

            <if test="facilityId!=null">
                and facility_id = #{facilityId}
            </if>

            <if test="containerId!=null">
                and container_id = #{containerId}
            </if>


            <if test="batch!=null and batch!=''">
                and batch = #{batch}
            </if>


            <if test="waveCode!=null and waveCode!=''">
                and wave_code = #{waveCode}
            </if>


            <if test="customerCode!=null and customerCode!=''">
                and customer_code = #{customerCode}
            </if>


            <if test="customerName!=null and customerName!=''">
                and customer_name = #{customerName}
            </if>


            <if test="storeCode!=null and storeCode!=''">
                and store_code = #{storeCode}
            </if>


            <if test="storeName!=null and storeName!=''">
                and store_name = #{storeName}
            </if>


            <if test="transportCode!=null and transportCode!=''">
                and transport_code = #{transportCode}
            </if>


            <if test="transportName!=null and transportName!=''">
                and transport_name = #{transportName}
            </if>


            <if test="productCode!=null and productCode!=''">
                and product_code = #{productCode}
            </if>


            <if test="productName!=null and productName!=''">
                and product_name = #{productName}
            </if>


            <if test="timeEffectCode!=null and timeEffectCode!=''">
                and time_effect_code = #{timeEffectCode}
            </if>


            <if test="timeEffectName!=null and timeEffectName!=''">
                and time_effect_name = #{timeEffectName}
            </if>

            <if test="status!=null">
                and status = #{status}
            </if>

            <if test="ouId!=null">
                and ou_id = #{ouId}
            </if>

            <if test="outerContainerId!=null">
                and outer_container_id = #{outerContainerId}
            </if>

            <if test="containerLatticeNo!=null">
                and container_lattice_no = #{containerLatticeNo}
            </if>

            <if test="outboundboxId!=null">
                and outboundbox_id = #{outboundboxId}
            </if>


            <if test="outboundboxCode!=null and outboundboxCode!=''">
                and outboundbox_code = #{outboundboxCode}
            </if>


            <if test="distributionMode!=null and distributionMode!=''">
                and distribution_mode = #{distributionMode}
            </if>


            <if test="pickingMode!=null and pickingMode!=''">
                and picking_mode = #{pickingMode}
            </if>


            <if test="checkingMode!=null and checkingMode!=''">
                and checking_mode = #{checkingMode}
            </if>
            
            <if test="createTime!=null">
					and create_time = #{createTime}
				</if>
	       
				<if test="lastModifyTime!=null">
					and last_modify_time = #{lastModifyTime}
				</if>
	       
				<if test="createId!=null">
					and create_id = #{createId}
				</if>
	       
				<if test="modifiedId!=null">
					and modified_id = #{modifiedId}
				</if>
        </where>
    </sql>
     <select id="findListByParamWithNoFinish" resultMap="WhCheckingResultExt">
        select
        <include refid="whCheckingColumnsExt"/>
        from t_wh_checking
        <include refid="whCheckingDynamicWhereWithNoFinish"/>
    </select>
    
    <select id="findByOutboundBoxCodeForChecking" resultMap="WeightingCommand" flushCache="false">
		SELECT
			consumable.store_name AS storeName,
			consumable.customer_name AS customerName,
			consumable.sku_barcode AS skuCode,
			consumable.waybill_code AS waybillCode,
			consumable.transport_code AS transportCode,
			consumable.batch AS batch,
			consumable.wave_code AS waveCode,
			consumable.odo_code AS odoCode,
			consumable.outboundbox_code AS outboundboxCode,
			consumable.odo_id as odoId,
			info.calc_weight AS calcWeighting,
			info.floats AS floats
		FROM
			t_wh_outbound_consumable consumable
		LEFT JOIN t_wh_odo_package_info info ON consumable.outboundbox_code = info.outboundbox_code
		WHERE
			consumable.outboundbox_code = #{outboundBoxCode}
		AND consumable.ou_id = #{ouId}
		LIMIT 1
    </select>

    <select id="findByOutboundBoxCodeForChecking1" resultMap="WeightingCommand" flushCache="false">
		SELECT
			info.outboundbox_code AS outboundboxCode,
			pack.calc_weight AS calcWeighting,
			pack.floats AS floats,
			odo.id as odoId,
			odo.odo_code AS odoCode,
			box.wave_code AS waveCode,
			box.batch AS batch,
			info.transport_code AS transportCode,
			info.waybill_code AS waybillCode,
			consumable.sku_barcode AS skuCode,
			box.customer_name AS customerName,
			box.store_name AS storeName
		FROM
			t_wh_odo_delivery_info info
		LEFT JOIN t_wh_outboundbox box ON info.outboundbox_code = box.outboundbox_code
		AND info.odo_id = box.odo_id
		LEFT JOIN t_wh_odo odo ON info.odo_id = odo.id
		LEFT JOIN t_wh_odo_package_info pack ON pack.odo_id = info.odo_id
		LEFT JOIN t_wh_outbound_consumable consumable ON consumable.outboundbox_code = info.outboundbox_code
		WHERE
			info.outboundbox_code = #{outboundBoxCode}
			and pack.outboundbox_code = #{outboundBoxCode}
			AND info.ou_id = #{ouId}
			and box.status in ('1', '8')
		LIMIT 1
    </select>

    <select id="findBatchBoxCntByParam" resultType="java.lang.Long" flushCache="false">
		SELECT
			count(distinct checking.outboundbox_code)
		FROM
			t_wh_checking checking
		WHERE
			checking.batch = #{batch}
			AND checking.ou_id = #{ouId}
    </select>

    <select id="findBatchBoxCntCheckByParam" resultType="java.lang.Long" flushCache="false">
		SELECT
			count(distinct checking.outboundbox_code)
		FROM
			t_wh_checking checking
		WHERE
			checking.batch = #{batch}
			AND checking.ou_id = #{ouId}
			and checking.status != 10
    </select>

    <select id="findBatchOdoCntByParam" resultType="java.lang.Long" flushCache="false">
		SELECT
			count(distinct line.odo_id)
		FROM
			t_wh_checking checking left join t_wh_checking_line line on checking.id = line.checking_id
		WHERE
			checking.batch = #{batch}
			AND checking.ou_id = #{ouId}
    </select>

    <select id="findBatchOdoCntCheckByParam" resultType="java.lang.Long" flushCache="false">
		SELECT
			count(distinct line.odo_id)
		FROM
			t_wh_checking checking left join t_wh_checking_line line on checking.id = line.checking_id
		WHERE
			checking.batch = #{batch}
			AND checking.ou_id = #{ouId}
			and checking.status != 10
    </select>
    
    <select id="findOdoSkuCntByParam" resultType="java.lang.Long" flushCache="false">
		SELECT
			sum(line.qty) - sum(line.checking_qty)
		FROM
			t_wh_checking checking
		LEFT JOIN t_wh_checking_line line ON checking.id = line.checking_id
		LEFT JOIN t_wh_odo odo ON odo.id = line.odo_id
		WHERE
			odo.odo_code = #{odoCode}
		AND checking.ou_id = #{ouId}
		AND checking.`status` != 10
    </select>

    <select id="findBoxSkuCntByBoxAndOuId" resultType="java.lang.Long" flushCache="false">
		SELECT
			sum(line.qty) - sum(line.checking_qty)
		FROM
			t_wh_checking checking
		LEFT JOIN t_wh_checking_line line ON checking.id = line.checking_id
		WHERE
			checking.outboundbox_code = #{outboundBoxCode}
		AND checking.ou_id = #{ouId}
		AND checking.`status` != 10
    </select>

</mapper>
