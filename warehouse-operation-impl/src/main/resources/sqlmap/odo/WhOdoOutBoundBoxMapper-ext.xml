<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="com.baozun.scm.primservice.whoperation.dao.odo.WhOdoOutBoundBoxDao">
    <resultMap id="WhOdoOutBoundBoxResultExt" type="com.baozun.scm.primservice.whoperation.model.odo.WhOdoOutBoundBox">
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="whOdoOutBoundBoxColumnsExt">
        <![CDATA[
                id as id,
                wave_id as waveId,
                odo_id as odoId,
                odo_line_id as odoLineId,
                outbounxbox_type_id as outbounxboxTypeId,
                outbounxbox_type_code as outbounxboxTypeCode,
                container_id as containerId,
                outer_container_id as outerContainerId,
                container_lattice_no as containerLatticeNo,
                qty as qty,
                box_batch as boxBatch,
                whole_case as wholeCase,
                ou_id as ouId,
                is_create_work as isCreateWork,
                create_time as createTime,
                last_modify_time as lastModifyTime,
                operator_id as operatorId
        ]]>
    </sql>

    <sql id="whOdoOutBoundBoxDynamicWhereExt">
        <!-- ognl访问静态方法的表达式 为@class@method(args),以下为调用rapid中的Ognl.isNotEmpty()方法,还有其它方法如isNotBlank()可以使用，具体请查看Ognl类 -->
        <where>

            <if test="id!=null">
                and id = #{id}
            </if>
            
            <if test="waveId!=null">
                and wave_id = #{waveId}
            </if>

            <if test="odoId!=null">
                and odo_id = #{odoId}
            </if>

            <if test="odoLineId!=null">
                and odo_line_id = #{odoLineId}
            </if>

            <if test="outbounxboxTypeId!=null">
                and outbounxbox_type_id = #{outbounxboxTypeId}
            </if>


            <if test="outbounxboxTypeCode!=null and outbounxboxTypeCode!=''">
                and outbounxbox_type_code = #{outbounxboxTypeCode}
            </if>

            <if test="containerId!=null">
                and container_id = #{containerId}
            </if>

            <if test="outerContainerId!=null">
                and outer_container_id = #{outerContainerId}
            </if>

			<if test="containerLatticeNo!=null">
                and container_lattice_no = #{containerLatticeNo}
            </if>

            <if test="qty!=null">
                and qty = #{qty}
            </if>
            
            <if test="boxBatch!=null">
                and box_batch = #{boxBatch}
            </if>
            
            <if test="wholeCase!=null">
                and whole_case = #{wholeCase}
            </if>

            <if test="ouId!=null">
                and ou_id = #{ouId}
            </if>

            <if test="isCreateWork!=null">
                and is_create_work = #{isCreateWork}
            </if>

            <if test="createTime!=null">
                and create_time = #{createTime}
            </if>

            <if test="lastModifyTime!=null">
                and last_modify_time = #{lastModifyTime}
            </if>

            <if test="operatorId!=null">
                and operator_id = #{operatorId}
            </if>
        </where>
    </sql>


    <update id="updateByVersion" parameterType="com.baozun.scm.primservice.whoperation.model.odo.WhOdoOutBoundBox">
        <![CDATA[
                UPDATE t_wh_odo_outboundbox SET
                    wave_id = #{waveId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    odo_id = #{odoId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    odo_line_id = #{odoLineId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    outbounxbox_type_id = #{outbounxboxTypeId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    outbounxbox_type_code = #{outbounxboxTypeCode,javaType=java.lang.String,jdbcType=VARCHAR} ,
                    container_id = #{containerId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    outer_container_id = #{outerContainerId,javaType=java.lang.Long,jdbcType=BIGINT} ,
                    container_lattice_no = #{containerLatticeNo,javaType=java.lang.Integer,jdbcType=INTEGER} ,
                    qty = #{qty,javaType=Double,jdbcType=DECIMAL} ,
                    box_batch = #{boxBatch,javaType=java.lang.String,jdbcType=VARCHAR} ,
                    whole_case = #{wholeCase,javaType=java.lang.Integer,jdbcType=INTEGER} ,
                    is_create_work = #{isCreateWork,javaType=java.lang.Boolean,jdbcType=BIT} ,
                    create_time = #{createTime,javaType=java.util.Date,jdbcType=TIMESTAMP} ,
                    last_modify_time = now() ,
                    operator_id = #{operatorId,javaType=java.lang.Long,jdbcType=BIGINT} 
                WHERE 
                    id = #{id} 
                    and ou_id = #{ouId}
                    and last_modify_time    =  #{lastModifyTime}
            ]]>
    </update>
    
    <resultMap id="whOdoOutBoundBoxCommandResultExt" type="com.baozun.scm.primservice.whoperation.command.odo.WhOdoOutBoundBoxCommand">
    </resultMap>
    
    <select id="findPickingWorkWhOdoOutBoundBox" resultMap="WhOdoOutBoundBoxResultExt">
		select 
			distinct wave.id as waveId, 
			outboundbox.box_batch as boxBatch 
		from 
			t_wh_wave wave, 
			t_wh_wave_template waveTemplate, 
			t_wh_wave_phase wavePhase, 
			t_wh_wave_master waveMaster, 
			t_wh_odo_outboundbox outboundbox 
		where 
			outboundbox.wave_id = wave.id 
			and outboundbox.is_create_work != 1 
			and wave.wave_master_id = waveMaster.id 
			and waveTemplate.id = waveMaster.wave_template_id 
			and wavePhase.wave_template_id = waveTemplate.id 
			and wave.id = #{waveId} 
			and wave.ou_id = #{ouId} 
	</select>
	
	<select id="getOdoOutBoundBoxForGroup" resultMap="WhOdoOutBoundBoxResultExt">
		select
			<include refid="whOdoOutBoundBoxColumnsExt"/>
		from
			t_wh_odo_outboundbox
		where
			ou_id = #{ouId}
			and box_batch = #{boxBatch}
			and is_create_work != 1
			and whole_case is not null
		group by
			whole_case
		union all
		select
			<include refid="whOdoOutBoundBoxColumnsExt"/>
		from
			t_wh_odo_outboundbox
		where
			ou_id = #{ouId}
			and box_batch = #{boxBatch}
			and is_create_work != 1
			and whole_case is null
			and outer_container_id is not null
		group by
			outer_container_id
		union all
		select
			<include refid="whOdoOutBoundBoxColumnsExt"/>
		from
			t_wh_odo_outboundbox
		where
			ou_id = #{ouId}
			and box_batch = #{boxBatch}
			and is_create_work != 1
			and whole_case is null
			and outer_container_id is null
			and outbounxbox_type_code is not null
			and container_id is null
		group by
			outbounxbox_type_code
		union all
		select
			<include refid="whOdoOutBoundBoxColumnsExt"/>
		from
			t_wh_odo_outboundbox
		where
			ou_id = #{ouId}
			and box_batch = #{boxBatch}
			and is_create_work != 1
			and whole_case is null
			and outer_container_id is null
			and outbounxbox_type_code is null
			and container_id is not null
		group by
			container_id
	</select>
	
	<select id="getOdoOutBoundBoxListByGroup" resultMap="whOdoOutBoundBoxCommandResultExt">
		select
			<include refid="whOdoOutBoundBoxColumnsExt"/>
		from
			t_wh_odo_outboundbox
		<where>
			ou_id = #{ouId}
			and box_batch = #{boxBatch}
			and is_create_work != 1
			<if test="wholeCase!=null">
				and whole_case = #{wholeCase}
			</if>
			<if test="outerContainerId!=null and wholeCase==null">
				and outer_container_id = #{outerContainerId}
			</if>
			<if test="outerContainerId==null and wholeCase==null and outbounxboxTypeCode!=null and containerId==null">
				and outbounxbox_type_code = #{outbounxboxTypeCode}
			</if>
			<if test="outerContainerId==null and wholeCase==null and outbounxboxTypeCode==null and containerId!=null">
				and container_id = #{containerId}
			</if>
		</where>
	</select>
	
	<select id="findOutboundboxType" resultType="long">
		select
			sku_id
		from
			t_wh_outboundbox_type
		<where>
			ou_id = #{ouId}
			and id = #{outbounxboxTypeId}
			and code = #{outbounxboxTypeCode}
		</where>
	</select>
	
	<select id="findWhOdoOutBoundBoxCommandById" resultMap="whOdoOutBoundBoxCommandResultExt">
		select
			<include refid="whOdoOutBoundBoxColumnsExt"/>
		from
			t_wh_odo_outboundbox
		<where>
			ou_id = #{ouId}
			<if test="id!=null">
				and id = #{id}
			</if>
		</where>
	</select>
	
	<select id="findQtyByOdoLineId" resultType="Double">
		select
			sum(qty)
		from
			t_wh_odo_outboundbox
		<where>
			ou_id = #{ouId}
			<if test="odoLineId!=null">
				and odo_line_id = #{odoLineId}
			</if>
		</where>
	</select>
	
	<select id="getBatchListByWaveId" resultType="string">
    	select
			b.box_batch
		from
			t_wh_odo_outboundbox b
		where
			b.wave_id = #{waveId}
			and b.ou_id = #{ouId}
		group by b.box_batch
    </select>
    
    <select id="getOdoIdListByBatch" resultType="long">
    	select
			b.odo_id
		from
			t_wh_odo_outboundbox b
		where
			b.wave_id = #{waveId}
			and b.ou_id = #{ouId}
			and b.box_batch = #{batch}
		group by b.odo_id
    </select>
    
    <select id="gethOdoOutBoundBoxLstByOdo" resultMap="whOdoOutBoundBoxCommandResultExt">
		select
			<include refid="whOdoOutBoundBoxColumnsExt"/>
		from
			t_wh_odo_outboundbox
		<where>
			ou_id = #{ouId}
			<if test="odoId!=null">
				and odo_id = #{odoId}
			</if>
			<if test="odoLineId!=null">
				and odo_line_id = #{odoLineId}
			</if>
			<if test="isCreateWork!=null">
				and is_create_work = #{isCreateWork}
			</if>
		</where>
	</select>
</mapper>
